<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Coin Bekasi PPE Database</title>
    
    <!-- Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('root').innerHTML = `
                <div style="color: #b91c1c; background: #fef2f2; padding: 20px; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                    <h1 style="font-size: 24px; margin-bottom: 10px;">⚠️ App Error</h1>
                    <p><strong>${msg}</strong></p>
                    <button onclick="localStorage.clear(); window.location.reload()" style="margin-top:20px; background: #dc2626; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Reset Data</button>
                </div>
            `;
            return false;
        };
    </script>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .logo-hover:hover .logo-edit { opacity: 1; }
    </style>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        safety: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c', 700: '#c2410c' }
                    }
                }
            }
        }
    </script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS ---
        const Icons = {
            Dashboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3"/><rect width="7" height="5" x="14" y="3"/><rect width="7" height="9" x="14" y="12"/><rect width="7" height="5" x="3" y="16"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Qr: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M16 16l-2.74 2.74"/><path d="M21 21v-5h-5"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            CloudUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/><polyline points="12 13 12 21"/><polyline points="9 16 12 13 15 16"/></svg>,
            Excel: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>,
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        };

        // --- CONSTANTS ---
        const STORAGE_KEYS = { INVENTORY: 'ppe_inv', TRANSACTIONS: 'ppe_tx', INV_LOGS: 'ppe_inv_logs', SETTINGS: 'ppe_set', LOGO: 'ppe_logo' };
        
        // --- SERVICES ---
        const safeParse = (key, fallback) => { try { return JSON.parse(localStorage.getItem(key)) || fallback; } catch { return fallback; } };
        const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));

        const deduplicateInventory = (items) => {
            const map = new Map();
            items.forEach(item => {
                const id = String(item.id).trim();
                if (!map.has(id)) {
                    map.set(id, { ...item, id });
                } else {
                    const existing = map.get(id);
                    if (new Date(item.lastUpdated) > new Date(existing.lastUpdated)) {
                        map.set(id, { ...item, id });
                    }
                }
            });
            return Array.from(map.values());
        };

        const syncSheets = async (url, inv, tx, logs, logo) => {
            if(!url) return;
            try { 
                await fetch(url, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'text/plain;charset=utf-8'}, 
                    body: JSON.stringify({ action: 'SYNC', inventory: inv, transactions: tx, logs: logs, logo: logo }) 
                }); 
            } catch(e) { console.log('Sync error', e); }
        };

        const fetchSheets = async (url) => {
            if(!url) return null;
            try {
                const res = await fetch(`${url}?action=GET_DATA`);
                const data = await res.json();
                return data.status === 'success' ? data : null;
            } catch(e) { 
                console.error("Fetch Error:", e);
                return null; 
            }
        };

        const callGemini = async (apiKey, prompt, systemInstruction) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    system_instruction: { parts: [{ text: systemInstruction }] },
                    generationConfig: { response_mime_type: "application/json" }
                })
            });
            const data = await response.json();
            if(data.error) throw new Error(data.error.message);
            return data;
        };

        const exportToExcel = (data, type) => {
            let html = '';
            if (type === 'INVENTORY') {
                html = `
                    <table border="1">
                        <thead>
                            <tr style="background-color: #cccccc; font-weight: bold;">
                                <th style="width: 50px;">No</th>
                                <th style="width: 200px;">Name of the PPE</th>
                                <th style="width: 100px;">Quantity</th>
                                <th style="width: 100px;">Category</th>
                                <th style="width: 80px;">Unit</th>
                                <th style="width: 150px;">Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((item, index) => `
                                <tr>
                                    <td style="text-align: center;">${index + 1}</td>
                                    <td>${item.name}</td>
                                    <td style="text-align: center;">${item.quantity}</td>
                                    <td>${item.category}</td>
                                    <td style="text-align: center;">${item.unit}</td>
                                    <td>${new Date(item.lastUpdated).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (type === 'HISTORY') {
                html = `
                    <table border="1">
                        <thead>
                            <tr style="background-color: #cccccc; font-weight: bold;">
                                <th style="width: 50px;">No</th>
                                <th style="width: 100px;">Date</th>
                                <th style="width: 100px;">Time</th>
                                <th style="width: 150px;">Employee Name</th>
                                <th style="width: 150px;">Department</th>
                                <th style="width: 200px;">Items Taken</th>
                                <th style="width: 80px;">Method</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((tx, index) => `
                                <tr>
                                    <td style="text-align: center;">${index + 1}</td>
                                    <td>${new Date(tx.timestamp).toLocaleDateString()}</td>
                                    <td>${new Date(tx.timestamp).toLocaleTimeString()}</td>
                                    <td>${tx.employeeName}</td>
                                    <td>${tx.department || '-'}</td>
                                    <td>${tx.items.map(i => `${i.quantity}x ${i.itemName}`).join(', ')}</td>
                                    <td>${tx.method}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (type === 'LOGS') {
                 html = `
                    <table border="1">
                        <thead>
                            <tr style="background-color: #cccccc; font-weight: bold;">
                                <th style="width: 50px;">No</th>
                                <th style="width: 100px;">Date</th>
                                <th style="width: 100px;">Time</th>
                                <th style="width: 80px;">Action</th>
                                <th style="width: 150px;">Item Name</th>
                                <th style="width: 200px;">Change Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((log, index) => `
                                <tr>
                                    <td style="text-align: center;">${index + 1}</td>
                                    <td>${new Date(log.timestamp).toLocaleDateString()}</td>
                                    <td>${new Date(log.timestamp).toLocaleTimeString()}</td>
                                    <td>${log.action}</td>
                                    <td>${log.itemName}</td>
                                    <td>${log.changeDetails}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            const blob = new Blob(['\ufeff', html], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GoldCoin_${type}_${new Date().toISOString().split('T')[0]}.xls`;
            a.click();
        };

        // --- COMPONENTS ---

        const SimpleChart = ({ data }) => {
            const max = Math.max(...data.map(i=>i.quantity), 1);
            return (
                <div className="h-48 flex items-end gap-2 w-full pt-8 pb-2 overflow-x-auto">
                    {data.map(i => {
                        const h = (i.quantity / max) * 100;
                        const isLow = i.quantity <= i.threshold;
                        return (
                            <div key={i.id} className="flex-1 min-w-[40px] h-full flex flex-col justify-end group relative">
                                <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                    {i.name}: {i.quantity}
                                </div>
                                <div style={{height: `${h}%`}} className={`w-full rounded-t ${isLow ? 'bg-red-500' : 'bg-safety-500'} opacity-80 group-hover:opacity-100 transition-all`}></div>
                                <div className="text-[10px] text-slate-400 mt-1 truncate text-center">{i.name.substring(0,6)}..</div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const SearchableSelect = ({ items, value, onChange, placeholder }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState('');
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const selectedItem = items.find(i => String(i.id).trim() === String(value).trim());
            
            const filteredItems = useMemo(() => {
                let data = items || [];
                if (search.trim()) {
                    const lower = search.toLowerCase();
                    data = data.filter(item => 
                        String(item.name || '').toLowerCase().includes(lower) || 
                        String(item.category || '').toLowerCase().includes(lower)
                    );
                }
                return [...data].sort((a, b) => {
                    const nameA = String(a.name || '').toLowerCase();
                    const nameB = String(b.name || '').toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    return String(a.id || '').localeCompare(String(b.id || ''));
                });
            }, [items, search]);

            return (
                <div className="relative" ref={wrapperRef}>
                    <div 
                        className="w-full p-2 border rounded flex justify-between items-center bg-white cursor-text"
                        onClick={() => { setIsOpen(true); }}
                    >
                        {isOpen ? (
                            <input 
                                type="text"
                                autoFocus
                                autoComplete="off"
                                autoCorrect="off"
                                spellCheck="false"
                                className="w-full outline-none text-sm"
                                placeholder="Type to search..."
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                                onKeyDown={e => { if(e.key === 'Enter') e.preventDefault(); }}
                            />
                        ) : (
                            <span className={`text-sm ${!selectedItem ? "text-slate-400" : "text-slate-800"}`}>
                                {selectedItem ? `${selectedItem.name} (${selectedItem.quantity})` : placeholder}
                            </span>
                        )}
                        <Icons.Search className="w-4 h-4 text-slate-400"/>
                    </div>
                    
                    {isOpen && (
                        <div className="absolute z-50 w-full bg-white border rounded shadow-lg max-h-60 overflow-auto mt-1">
                            {filteredItems.length > 0 ? filteredItems.map((item, index) => (
                                <div 
                                    key={`${item.id}-${index}`}
                                    className={`p-2 hover:bg-slate-100 cursor-pointer ${item.quantity === 0 ? 'opacity-50' : ''}`}
                                    onClick={() => {
                                        if(item.quantity > 0) {
                                            onChange(item.id);
                                            setIsOpen(false);
                                            setSearch('');
                                        }
                                    }}
                                >
                                    <div className="font-bold text-sm">{item.name}</div>
                                    <div className="text-xs text-slate-500">Qty: {item.quantity} • {item.category}</div>
                                </div>
                            )) : (
                                <div className="p-2 text-sm text-slate-500 text-center">No items found</div>
                            )}
                        </div>
                    )}
                </div>
            )
        };

        const InventoryModal = ({ isOpen, onClose, initialData, onSave }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6 animate-fade-in" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">{initialData ? 'Edit Item' : 'Add Item'}</h3>
                            <button onClick={onClose} className="text-slate-400 font-bold text-xl">&times;</button>
                        </div>
                        <form onSubmit={(e)=>{
                            e.preventDefault();
                            const fd = new FormData(e.target);
                            const formId = fd.get('obj_id');
                            const finalId = (formId && formId !== '') ? String(formId) : Date.now().toString();

                            onSave({
                                id: finalId,
                                name: fd.get('name'),
                                category: fd.get('category'),
                                quantity: Number(fd.get('quantity')),
                                unit: fd.get('unit'),
                                threshold: Number(fd.get('threshold')),
                                lastUpdated: new Date().toISOString()
                            });
                        }} className="space-y-4">
                            <input type="hidden" name="obj_id" defaultValue={initialData ? initialData.id : ''} />
                            
                            <div><label className="text-xs font-bold text-slate-500">NAME</label><input name="name" className="w-full p-2 border rounded" required defaultValue={initialData?.name}/></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-slate-500">CATEGORY</label><select name="category" className="w-full p-2 border rounded" defaultValue={initialData?.category||'General'}><option>Head</option><option>Eye</option><option>Hand</option><option>Foot</option><option>Apparel</option><option>General</option></select></div>
                                <div><label className="text-xs font-bold text-slate-500">UNIT</label><input name="unit" className="w-full p-2 border rounded" defaultValue={initialData?.unit||'pcs'}/></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-slate-500">QTY</label><input name="quantity" type="number" className="w-full p-2 border rounded" required defaultValue={initialData?.quantity||0}/></div>
                                <div><label className="text-xs font-bold text-slate-500">LIMIT</label><input name="threshold" type="number" className="w-full p-2 border rounded" defaultValue={initialData?.threshold||5}/></div>
                            </div>
                            <button className="w-full bg-safety-600 text-white py-2 rounded font-bold hover:bg-safety-700">Save Item</button>
                        </form>
                    </div>
                </div>
            );
        };

        const TransactionModal = ({ isOpen, onClose, initialData, onSave }) => {
            if(!isOpen || !initialData) return null;
            const dateObj = new Date(initialData.timestamp);
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6 animate-fade-in" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">Edit Log</h3>
                            <button onClick={onClose} className="text-slate-400 font-bold text-xl">&times;</button>
                        </div>
                        <div className="mb-4 text-xs text-amber-600 bg-amber-50 p-2 rounded border border-amber-200">
                            Editing details does not revert inventory quantities.
                        </div>
                        <form onSubmit={(e)=>{
                            e.preventDefault();
                            const fd = new FormData(e.target);
                            onSave({
                                ...initialData,
                                employeeName: fd.get('employeeName'),
                                department: fd.get('department'),
                                timestamp: new Date(fd.get('date') + 'T' + fd.get('time')).toISOString()
                            });
                        }} className="space-y-4">
                            <div><label className="text-xs font-bold text-slate-500">EMPLOYEE</label><input name="employeeName" className="w-full p-2 border rounded" required defaultValue={initialData.employeeName}/></div>
                            <div>
                                <label className="text-xs font-bold text-slate-500">DEPARTMENT</label>
                                <input name="department" list="depts-modal" className="w-full p-2 border rounded" defaultValue={initialData.department||''}/>
                                <datalist id="depts-modal"><option value="Production"/><option value="Logistics"/><option value="Warehouse"/><option value="Engineering"/><option value="Office"/></datalist>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-slate-500">DATE</label><input type="date" name="date" className="w-full p-2 border rounded" required defaultValue={dateObj.toISOString().split('T')[0]}/></div>
                                <div><label className="text-xs font-bold text-slate-500">TIME</label><input type="time" name="time" className="w-full p-2 border rounded" required defaultValue={dateObj.toTimeString().slice(0,5)}/></div>
                            </div>
                            <button className="w-full bg-safety-600 text-white py-2 rounded font-bold hover:bg-safety-700">Update Log</button>
                        </form>
                    </div>
                </div>
            );
        };

        const PersonalTrackerView = ({ transactions }) => {
            const [selectedEmployee, setSelectedEmployee] = useState('');
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM

            const employees = useMemo(() => {
                return Array.from(new Set(transactions.map(t => t.employeeName))).sort();
            }, [transactions]);

            const stats = useMemo(() => {
                if (!selectedEmployee || !month) return { total: 0, items: {}, list: [] };

                const [y, m] = month.split('-');
                const targetDate = new Date(Number(y), Number(m) - 1);
                
                const filtered = transactions.filter(t => {
                    const d = new Date(t.timestamp);
                    return t.employeeName === selectedEmployee && 
                        d.getMonth() === targetDate.getMonth() && 
                        d.getFullYear() === targetDate.getFullYear();
                });

                const itemCounts = {};
                filtered.forEach(t => {
                    t.items.forEach(i => {
                        itemCounts[i.itemName] = (itemCounts[i.itemName] || 0) + i.quantity;
                    });
                });

                return {
                    total: filtered.reduce((acc, t) => acc + t.items.reduce((s, i) => s + i.quantity, 0), 0),
                    items: itemCounts,
                    list: filtered
                };
            }, [transactions, selectedEmployee, month]);

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 className="text-xl font-bold">Personal Tracker</h2>
                    </div>
                    
                    <div className="bg-white p-6 rounded shadow border space-y-4">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 block">SELECT EMPLOYEE</label>
                                <select 
                                    className="w-full p-2 border rounded"
                                    value={selectedEmployee}
                                    onChange={e => setSelectedEmployee(e.target.value)}
                                >
                                    <option value="">-- Select Person --</option>
                                    {employees.map(e => <option key={e} value={e}>{e}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 block">SELECT MONTH</label>
                                <input 
                                    type="month" 
                                    className="w-full p-2 border rounded"
                                    value={month}
                                    onChange={e => setMonth(e.target.value)}
                                />
                            </div>
                        </div>
                    </div>

                    {selectedEmployee && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="bg-white p-6 rounded shadow border">
                                <h3 className="font-bold text-lg mb-4 text-center">Summary</h3>
                                <div className="text-center mb-6">
                                    <div className="text-4xl font-bold text-safety-600">{stats.total}</div>
                                    <div className="text-xs text-slate-400 uppercase">Items Taken</div>
                                </div>
                                <div className="space-y-2">
                                    {Object.entries(stats.items).map(([name, qty]) => (
                                        <div key={name} className="flex justify-between text-sm border-b pb-1 last:border-0">
                                            <span>{name}</span>
                                            <span className="font-bold">{qty}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="lg:col-span-2 bg-white p-6 rounded shadow border">
                                <h3 className="font-bold text-lg mb-4">Transaction Details</h3>
                                {stats.list.length > 0 ? (
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-50 text-xs font-bold uppercase text-slate-500">
                                            <tr>
                                                <th className="p-2 text-left">Date</th>
                                                <th className="p-2 text-left">Items</th>
                                                <th className="p-2 text-left">Method</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {stats.list.map(t => (
                                                <tr key={t.id}>
                                                    <td className="p-2">{new Date(t.timestamp).toLocaleDateString()}</td>
                                                    <td className="p-2">
                                                        {t.items.map((i, k) => (
                                                            <span key={k} className="inline-block bg-slate-100 rounded px-2 py-1 text-xs mr-1 mb-1">
                                                                {i.quantity}x {i.itemName}
                                                            </span>
                                                        ))}
                                                    </td>
                                                    <td className="p-2 text-slate-400 text-xs">{t.method}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                ) : (
                                    <div className="text-center text-slate-400 py-8">No records for this period.</div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const DashboardView = ({ inventory, coTab, setCoTab, coData, setCoData, aiPrompt, setAiPrompt, aiLoading, handleCheckout, handleAiCheckout }) => (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
                <div className="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border h-fit">
                    <h2 className="font-bold mb-4">Quick Checkout</h2>
                    <div className="flex border-b mb-4">
                        <button onClick={()=>setCoTab('manual')} className={`flex-1 py-2 text-sm font-bold ${coTab==='manual'?'text-safety-600 border-b-2 border-safety-600':''}`}>Manual</button>
                        <button onClick={()=>setCoTab('ai')} className={`flex-1 py-2 text-sm font-bold ${coTab==='ai'?'text-indigo-600 border-b-2 border-indigo-600':''}`}>AI Voice</button>
                    </div>
                    {coTab === 'manual' ? (
                        <form onSubmit={e=>{
                                e.preventDefault(); 
                                const qty = Number(coData.qty);
                                if (!qty || qty < 1) return alert("Please enter a valid quantity");
                                handleCheckout(coData.name, coData.dept, coData.item, qty, 'MANUAL');
                            }} className="space-y-3">
                            <input className="w-full p-2 border rounded" placeholder="Employee Name" required value={coData.name} onChange={e=>setCoData({...coData, name: e.target.value})}/>
                            <input className="w-full p-2 border rounded" placeholder="Department" list="depts-dash" required value={coData.dept} onChange={e=>setCoData({...coData, dept: e.target.value})}/>
                            <datalist id="depts-dash"><option value="Production"/><option value="Logistics"/><option value="Warehouse"/><option value="Engineering"/><option value="Office"/></datalist>
                            
                            <SearchableSelect 
                                items={inventory}
                                value={coData.item}
                                onChange={val => setCoData({...coData, item: val})}
                                placeholder="Search & Select Item..."
                            />

                            <input type="number" min="1" className="w-full p-2 border rounded" required value={coData.qty} onChange={e=>setCoData({...coData, qty: e.target.value})}/>
                            <button className="w-full bg-safety-600 text-white py-2 rounded font-bold hover:bg-safety-700">Submit</button>
                        </form>
                    ) : (
                        <form onSubmit={handleAiCheckout} className="space-y-3">
                            <p className="text-xs text-indigo-600 bg-indigo-50 p-2 rounded">Try: "Mike from Logistics took 2 helmets"</p>
                            <textarea className="w-full p-2 border rounded h-24" placeholder="Type here..." required value={aiPrompt} onChange={e=>setAiPrompt(e.target.value)}></textarea>
                            <button disabled={aiLoading} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 disabled:opacity-50">{aiLoading?'Processing...':'Process'}</button>
                        </form>
                    )}
                </div>
                <div className="lg:col-span-2 space-y-6">
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white p-4 rounded shadow border">
                            <p className="text-xs font-bold text-slate-500 uppercase">Total Items</p>
                            <p className="text-2xl font-bold">{inventory.reduce((a,b)=>a+b.quantity,0)}</p>
                        </div>
                        <div className="bg-white p-4 rounded shadow border">
                            <p className="text-xs font-bold text-slate-500 uppercase">Low Stock</p>
                            <p className={`text-2xl font-bold ${inventory.some(i=>i.quantity<=i.threshold)?'text-red-600':'text-green-600'}`}>{inventory.filter(i=>i.quantity<=i.threshold).length}</p>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded shadow border">
                        <h3 className="font-bold mb-4">Stock Overview</h3>
                        <SimpleChart data={inventory}/>
                    </div>
                </div>
            </div>
        );

        const InventoryView = ({ inventory, logs, setEditItem, setModalOpen, deleteItem }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [tab, setTab] = useState('ITEMS'); // ITEMS or LOGS
            
            const processedInventory = useMemo(() => {
                let data = inventory || [];
                if (searchTerm.trim()) {
                    const lower = searchTerm.toLowerCase();
                    data = data.filter(item => 
                        String(item.name || '').toLowerCase().includes(lower) || 
                        String(item.category || '').toLowerCase().includes(lower)
                    );
                }
                return [...data].sort((a, b) => {
                    const nameA = String(a.name || '').toLowerCase();
                    const nameB = String(b.name || '').toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    return String(a.id || '').localeCompare(String(b.id || ''));
                });
            }, [inventory, searchTerm]);

            const processedLogs = useMemo(() => {
                return [...logs].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
            }, [logs]);

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div className="flex items-center gap-4">
                            <h2 className="text-xl font-bold">Inventory Management</h2>
                            <div className="flex bg-white rounded border p-1">
                                <button onClick={() => setTab('ITEMS')} className={`px-3 py-1 text-xs font-bold rounded ${tab === 'ITEMS' ? 'bg-slate-800 text-white' : 'text-slate-500'}`}>Items</button>
                                <button onClick={() => setTab('LOGS')} className={`px-3 py-1 text-xs font-bold rounded ${tab === 'LOGS' ? 'bg-slate-800 text-white' : 'text-slate-500'}`}>Logs</button>
                            </div>
                        </div>

                        {tab === 'ITEMS' ? (
                            <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                                <div className="flex gap-2">
                                     <button onClick={()=>exportToExcel(inventory, 'INVENTORY')} className="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded flex items-center justify-center gap-2 hover:bg-emerald-700 shadow-sm"><Icons.Excel/> Export List</button>
                                </div>
                                <div className="flex gap-2 w-full sm:w-auto">
                                    <div className="relative flex-1 sm:flex-none">
                                        <Icons.Search className="absolute left-3 top-2.5 text-slate-400 w-4 h-4"/>
                                        <input 
                                            type="text"
                                            autoComplete="off"
                                            autoCorrect="off"
                                            spellCheck="false"
                                            className="w-full sm:w-64 pl-9 p-2 border rounded text-sm pr-8" 
                                            placeholder="Search items..." 
                                            value={searchTerm}
                                            onChange={e => setSearchTerm(e.target.value)}
                                        />
                                        {searchTerm && (
                                            <button onClick={() => setSearchTerm('')} className="absolute right-2 top-2 text-slate-400 hover:text-slate-600 font-bold">&times;</button>
                                        )}
                                    </div>
                                    <button onClick={()=>{setEditItem(null); setModalOpen(true);}} className="bg-safety-600 text-white px-4 py-2 rounded font-bold flex gap-2 items-center whitespace-nowrap"><Icons.Plus/> Add</button>
                                </div>
                            </div>
                        ) : (
                             <button onClick={()=>exportToExcel(processedLogs, 'LOGS')} className="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded flex items-center justify-center gap-2 hover:bg-emerald-700 shadow-sm"><Icons.Excel/> Export Logs</button>
                        )}
                    </div>

                    {tab === 'ITEMS' ? (
                        <div className="bg-white rounded border overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-xs font-bold uppercase text-slate-500">
                                    <tr>
                                        <th className="p-4 w-12 text-center">No</th>
                                        <th className="p-4">Item</th>
                                        <th className="p-4">Qty</th>
                                        <th className="p-4">Status</th>
                                        <th className="p-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {processedInventory.map((i, index) => (
                                        <tr key={`${i.id}-${index}`} className="hover:bg-slate-50 group">
                                            <td className="p-4 text-center font-mono text-slate-400">{index + 1}</td>
                                            <td className="p-4"><div className="font-bold">{i.name}</div><div className="text-xs text-slate-400">{i.category}</div></td>
                                            <td className="p-4">{i.quantity} {i.unit}</td>
                                            <td className="p-4"><span className={`px-2 py-1 rounded-full text-xs font-bold ${i.quantity<=i.threshold?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}`}>{i.quantity<=i.threshold?'Low':'OK'}</span></td>
                                            <td className="p-4 text-right flex justify-end gap-2 relative z-10">
                                                <button type="button" onClick={()=>{setEditItem(i); setModalOpen(true);}} className="text-slate-400 hover:text-indigo-600 p-2 hover:bg-slate-100 rounded transition-colors" title="Edit"><Icons.Edit/></button>
                                                <button type="button" onClick={()=>deleteItem(i.id)} className="text-slate-400 hover:text-red-600 p-2 hover:bg-slate-100 rounded transition-colors" title="Delete"><Icons.Trash/></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {processedInventory.length === 0 && (
                                        <tr><td colSpan="5" className="p-8 text-center text-slate-400">No items found matching "{searchTerm}"</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div className="bg-white rounded border overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-xs font-bold uppercase text-slate-500">
                                    <tr>
                                        <th className="p-4">Time</th>
                                        <th className="p-4">Action</th>
                                        <th className="p-4">Item</th>
                                        <th className="p-4">Details</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {processedLogs.map((log) => (
                                        <tr key={log.id} className="hover:bg-slate-50">
                                            <td className="p-4 whitespace-nowrap">
                                                <div className="font-bold">{new Date(log.timestamp).toLocaleDateString()}</div>
                                                <div className="text-xs text-slate-400">{new Date(log.timestamp).toLocaleTimeString()}</div>
                                            </td>
                                            <td className="p-4">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                    log.action === 'CREATE' ? 'bg-green-100 text-green-700' :
                                                    log.action === 'DELETE' ? 'bg-red-100 text-red-700' :
                                                    'bg-blue-100 text-blue-700'
                                                }`}>{log.action}</span>
                                            </td>
                                            <td className="p-4 font-medium">{log.itemName}</td>
                                            <td className="p-4 text-slate-600 font-mono text-xs">{log.changeDetails}</td>
                                        </tr>
                                    ))}
                                    {processedLogs.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">No logs available.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const SettingsView = ({ settings, setSettings, saveData, showNotif, doCloudSync, inventory, transactions, logs, onImport }) => {
            const [copied, setCopied] = useState(false);
            const [showGuide, setShowGuide] = useState(false);
            const [importText, setImportText] = useState('');
            const fileInputRef = useRef(null);
            const [importMode, setImportMode] = useState(null);

            // UPDATED GOOGLE SCRIPT CODE to include InventoryLogs
            const GOOGLE_SCRIPT_CODE = `function doPost(e){try{var d=JSON.parse(e.postData.contents);var s=SpreadsheetApp.getActiveSpreadsheet();var i=s.getSheetByName("Inventory")||s.insertSheet("Inventory");var t=s.getSheetByName("Transactions")||s.insertSheet("Transactions");var l=s.getSheetByName("InventoryLogs")||s.insertSheet("InventoryLogs");var c=s.getSheetByName("Settings")||s.insertSheet("Settings");if(d.action==="SYNC"){i.clear();i.appendRow(["ID","Name","Cat","Qty","Unit","Thresh","Last"]);if(d.inventory.length)i.getRange(2,1,d.inventory.length,7).setValues(d.inventory.map(x=>[x.id,x.name,x.category,x.quantity,x.unit,x.threshold,x.lastUpdated]));t.clear();t.appendRow(["ID","Emp","Dept","Items","Time","Method"]);if(d.transactions.length)t.getRange(2,1,d.transactions.length,6).setValues(d.transactions.map(x=>[x.id,x.employeeName,x.department||"-",x.items.map(z=>z.quantity+"x "+z.itemName).join(", "),x.timestamp,x.method]));l.clear();l.appendRow(["ID","Time","Action","Item","Details"]);if(d.logs&&d.logs.length)l.getRange(2,1,d.logs.length,5).setValues(d.logs.map(x=>[x.id,x.timestamp,x.action,x.itemName,x.changeDetails]));c.clear();c.appendRow(["Key","Value"]);if(d.logo)c.appendRow(["Logo",d.logo]);return ContentService.createTextOutput(JSON.stringify({status:"success"})).setMimeType(ContentService.MimeType.JSON);}}catch(e){return ContentService.createTextOutput(JSON.stringify({status:"error",message:e.toString()})).setMimeType(ContentService.MimeType.JSON);}} function doGet(e){try{var s=SpreadsheetApp.getActiveSpreadsheet();var i=s.getSheetByName("Inventory");var t=s.getSheetByName("Transactions");var l=s.getSheetByName("InventoryLogs");var c=s.getSheetByName("Settings");var inv=[];var tx=[];var logs=[];var logo="";if(i&&i.getLastRow()>1)inv=i.getRange(2,1,i.getLastRow()-1,7).getValues().map(r=>({id:String(r[0]),name:r[1],category:r[2],quantity:Number(r[3]),unit:r[4],threshold:Number(r[5]),lastUpdated:r[6]}));if(t&&t.getLastRow()>1)tx=t.getRange(2,1,t.getLastRow()-1,6).getValues().map(r=>({id:Number(r[0]),employeeName:r[1],department:r[2]||"General",items:r[3].toString().split(",").map(x=>{var m=x.trim().match(/^(\\d+)x\\s+(.+)$/);return{itemName:m?m[2]:x.trim(),quantity:m?Number(m[1]):0}}),timestamp:r[4],method:r[5]}));if(l&&l.getLastRow()>1)logs=l.getRange(2,1,l.getLastRow()-1,5).getValues().map(r=>({id:String(r[0]),timestamp:r[1],action:r[2],itemName:r[3],changeDetails:r[4]}));if(c&&c.getLastRow()>1){var r=c.getRange(2,1,c.getLastRow()-1,2).getValues().find(x=>x[0]==="Logo");if(r)logo=r[1];}return ContentService.createTextOutput(JSON.stringify({status:"success",inventory:inv,transactions:tx,logs:logs,logo:logo})).setMimeType(ContentService.MimeType.JSON);}catch(e){return ContentService.createTextOutput(JSON.stringify({status:"error",message:e.toString()})).setMimeType(ContentService.MimeType.JSON);}}`;

            const parseInventory = (text) => {
                const lines = text.trim().split('\n');
                return lines.map(line => {
                    const cols = line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                    const [name, category, quantity, unit, threshold] = cols;
                    if(!name) return null;
                    return {
                        id: Date.now() + Math.random().toString(),
                        name, category: category || 'General', quantity: Number(quantity) || 0, unit: unit || 'pcs', threshold: Number(threshold) || 5, lastUpdated: new Date().toISOString()
                    };
                }).filter(i => i);
            };

            const parseHistory = (text) => {
                const lines = text.trim().split('\n');
                return lines.map(line => {
                    const cols = line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                    const [date, time, emp, dept, item, qty, method] = cols;
                    if(!emp) return null;
                    return {
                        id: Date.now() + Math.random(),
                        employeeName: emp, department: dept || 'General',
                        items: [{itemName: item, quantity: Number(qty) || 1}],
                        timestamp: new Date(`${date}T${time}`).toISOString(),
                        method: method || 'IMPORT'
                    };
                }).filter(i => i);
            };

            const handleImportInv = () => {
                const newItems = parseInventory(importText);
                if(newItems.length) {
                    onImport(newItems, null);
                    setImportText('');
                    showNotif(`Imported ${newItems.length} items`);
                }
            };

            const handleImportHist = () => {
                const newTx = parseHistory(importText);
                if(newTx.length) {
                    onImport(null, newTx);
                    setImportText('');
                    showNotif(`Imported ${newTx.length} records`);
                }
            };

            const triggerFileUpload = (mode) => {
                setImportMode(mode);
                if(fileInputRef.current) {
                    fileInputRef.current.value = ''; // reset
                    fileInputRef.current.click();
                }
            };

            const onFileChange = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const text = evt.target.result;
                    if(importMode === 'INV') {
                         const data = parseInventory(text);
                         onImport(data, null);
                         showNotif(`Uploaded ${data.length} items`);
                    } else {
                         const data = parseHistory(text);
                         onImport(null, data);
                         showNotif(`Uploaded ${data.length} logs`);
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="max-w-2xl mx-auto space-y-6 animate-fade-in pb-12">
                     <div className="bg-white p-6 rounded border">
                        <h3 className="font-bold text-lg mb-4">Data Import (CSV)</h3>
                        <div className="text-xs text-slate-500 mb-2">Paste data OR upload .csv file. No headers needed.</div>
                        
                        <textarea 
                            className="w-full p-2 border rounded h-32 text-xs font-mono mb-4" 
                            placeholder="INVENTORY: Name, Category, Qty, Unit, MinLimit&#10;HISTORY: YYYY-MM-DD, HH:MM, Name, Dept, Item, Qty, Method"
                            value={importText}
                            onChange={e => setImportText(e.target.value)}
                        />
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div className="flex gap-2">
                                <button onClick={handleImportInv} className="bg-slate-200 text-slate-800 px-3 py-2 rounded text-sm font-bold flex-1 hover:bg-slate-300">Paste Inv</button>
                                <button onClick={()=>triggerFileUpload('INV')} className="bg-slate-200 text-slate-800 px-3 py-2 rounded text-sm font-bold hover:bg-slate-300 flex items-center justify-center" title="Upload CSV"><Icons.Upload/></button>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleImportHist} className="bg-slate-200 text-slate-800 px-3 py-2 rounded text-sm font-bold flex-1 hover:bg-slate-300">Paste Hist</button>
                                <button onClick={()=>triggerFileUpload('HIST')} className="bg-slate-200 text-slate-800 px-3 py-2 rounded text-sm font-bold hover:bg-slate-300 flex items-center justify-center" title="Upload CSV"><Icons.Upload/></button>
                            </div>
                        </div>
                        <input type="file" ref={fileInputRef} className="hidden" accept=".csv" onChange={onFileChange} />
                    </div>

                    <div className="bg-white p-6 rounded border">
                         <h3 className="font-bold text-lg mb-4">Export Data (Excel)</h3>
                         <div className="flex flex-col gap-3">
                            <button onClick={()=>exportToExcel(inventory, 'INVENTORY')} className="flex items-center justify-center gap-2 border p-3 rounded hover:bg-emerald-50 text-sm font-bold text-emerald-700">
                                <Icons.Excel/> Inventory List (.xls)
                            </button>
                            <button onClick={()=>exportToExcel(transactions, 'HISTORY')} className="flex items-center justify-center gap-2 border p-3 rounded hover:bg-emerald-50 text-sm font-bold text-emerald-700">
                                <Icons.Excel/> Transaction History (.xls)
                            </button>
                            <button onClick={()=>exportToExcel(logs, 'LOGS')} className="flex items-center justify-center gap-2 border p-3 rounded hover:bg-emerald-50 text-sm font-bold text-emerald-700">
                                <Icons.Excel/> Inventory Logs (.xls)
                            </button>
                         </div>
                    </div>

                    <div className="bg-white p-6 rounded border">
                         <h3 className="font-bold text-lg mb-2">Google Sheets Sync (Required for Phone Access)</h3>
                         <button onClick={()=>setShowGuide(!showGuide)} className="text-indigo-600 underline text-sm font-bold mb-4">
                            {showGuide ? "Hide Guide" : "Show Setup Guide"}
                         </button>
                         {showGuide && (
                             <div className="bg-indigo-50 border border-indigo-100 p-4 rounded text-sm text-slate-700 space-y-2 mb-6">
                                <p><strong>1. Get Code:</strong> Copy the code below.</p>
                                <p><strong>2. Google Sheets:</strong> Extensions &gt; Apps Script.</p>
                                <p><strong>3. Paste & Deploy:</strong> Paste code (Updated!). Click Deploy &gt; New Deployment.</p>
                                <p className="pl-4 border-l-2 border-indigo-300">
                                    Type: <strong>Web App</strong> | Access: <strong>Anyone</strong> (Critical!)
                                </p>
                                <p><strong>4. Connect:</strong> Paste the Web App URL below.</p>
                             </div>
                         )}
                         <div className="bg-slate-900 text-slate-300 p-3 rounded font-mono text-xs h-32 overflow-y-auto mb-2 relative">
                            {GOOGLE_SCRIPT_CODE}
                            <button onClick={()=>{navigator.clipboard.writeText(GOOGLE_SCRIPT_CODE); setCopied(true); setTimeout(()=>setCopied(false),2000);}} className="absolute top-2 right-2 bg-white text-slate-900 px-2 py-1 rounded font-bold text-xs hover:bg-slate-200">{copied ? "Copied!" : "Copy Code"}</button>
                         </div>
                        <label className="block text-xs font-bold text-slate-500 mb-1">Web App URL</label>
                        <input className="w-full p-2 border rounded mb-4 font-mono text-sm" placeholder="https://script.google.com/..." value={settings.sheetUrl} onChange={e=>setSettings({...settings, sheetUrl:e.target.value})}/>
                        <div className="flex gap-2">
                            <button onClick={()=>{saveData(STORAGE_KEYS.SETTINGS, settings); showNotif('Settings Saved');}} className="bg-safety-600 text-white px-4 py-2 rounded font-bold flex-1">Save Settings</button>
                            <button onClick={()=>doCloudSync(false, true)} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold flex-1 flex items-center justify-center gap-2"><Icons.CloudUp/> Force Save to Cloud</button>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded border">
                        <h3 className="font-bold mb-4">Gemini AI Key</h3>
                        <input type="password" className="w-full p-2 border rounded" placeholder="Paste API Key..." value={settings.apiKey} onChange={e=>setSettings({...settings, apiKey:e.target.value})}/>
                        <button onClick={()=>{saveData(STORAGE_KEYS.SETTINGS, settings); showNotif('Key Saved');}} className="mt-2 bg-slate-200 text-slate-700 px-4 py-1 rounded text-sm font-bold">Save Key</button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('DASHBOARD');
            const [inventory, setInventory] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [inventoryLogs, setInventoryLogs] = useState([]);
            const [settings, setSettings] = useState({ apiKey: '', sheetUrl: '' });
            const [notify, setNotify] = useState(null);
            const [logo, setLogo] = useState(null);
            
            // Modal States
            const [modalOpen, setModalOpen] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [txModalOpen, setTxModalOpen] = useState(false);
            const [editTx, setEditTx] = useState(null);
            
            const [qrOpen, setQrOpen] = useState(false);
            const [coTab, setCoTab] = useState('manual');
            
            const [coData, setCoData] = useState({ name: '', dept: '', item: '', qty: '1' });
            
            const [aiPrompt, setAiPrompt] = useState('');
            const [aiLoading, setAiLoading] = useState(false);

            // History Search
            const [txSearch, setTxSearch] = useState('');

            const showNotif = (msg) => { setNotify(msg); setTimeout(() => setNotify(null), 3000); };

            const doCloudSync = async (silent=false, forcePush=false) => {
                if(!settings.sheetUrl) { if(!silent) showNotif('No Sheet URL'); return; }
                if(!silent) showNotif(forcePush ? 'Saving to Cloud...' : 'Syncing...');
                
                if (forcePush) {
                    await syncSheets(settings.sheetUrl, inventory, transactions, inventoryLogs, logo);
                    if(!silent) showNotif('Saved to Cloud!');
                    return;
                }

                const cloud = await fetchSheets(settings.sheetUrl);
                if(cloud && cloud.inventory) {
                    const safeInv = cloud.inventory.map(i => ({...i, id: String(i.id).trim()}));
                    const uniqueInv = deduplicateInventory(safeInv);
                    
                    setInventory(uniqueInv);
                    setTransactions(cloud.transactions);
                    if(cloud.logs) {
                        setInventoryLogs(cloud.logs);
                        saveData(STORAGE_KEYS.INV_LOGS, cloud.logs);
                    }
                    
                    saveData(STORAGE_KEYS.INVENTORY, uniqueInv);
                    saveData(STORAGE_KEYS.TRANSACTIONS, cloud.transactions);
                    if(cloud.logo) {
                        setLogo(cloud.logo);
                        saveData(STORAGE_KEYS.LOGO, cloud.logo);
                    }
                    if(!silent) showNotif('Sync Complete!');
                } else {
                    if(!silent) showNotif('Sync Failed');
                }
            };

            // Logs Helper
            const addLog = (action, itemName, details) => {
                const newLog = {
                    id: Date.now().toString() + Math.random().toString().slice(2, 5),
                    timestamp: new Date().toISOString(),
                    action,
                    itemName,
                    changeDetails: details
                };
                const newLogs = [newLog, ...inventoryLogs];
                setInventoryLogs(newLogs);
                saveData(STORAGE_KEYS.INV_LOGS, newLogs);
                return newLogs;
            };

            useEffect(() => {
                const s = safeParse(STORAGE_KEYS.SETTINGS, { apiKey: '', sheetUrl: '' });
                setSettings(s);
                setLogo(localStorage.getItem(STORAGE_KEYS.LOGO));

                const loadedInv = safeParse(STORAGE_KEYS.INVENTORY, [
                    { id: '1', name: 'Helmet (White)', category: 'Head', quantity: 45, unit: 'pcs', threshold: 10, lastUpdated: new Date().toISOString() },
                    { id: '5', name: 'Gloves', category: 'Hand', quantity: 120, unit: 'prs', threshold: 50, lastUpdated: new Date().toISOString() },
                ]);
                const sanitized = loadedInv.map(i => ({...i, id: String(i.id).trim()}));
                const uniqueInv = deduplicateInventory(sanitized);
                setInventory(uniqueInv);

                setTransactions(safeParse(STORAGE_KEYS.TRANSACTIONS, []));
                setInventoryLogs(safeParse(STORAGE_KEYS.INV_LOGS, []));
                
                if(s.sheetUrl) {
                    fetchSheets(s.sheetUrl).then(d => {
                        if(d && d.inventory) {
                            const safeInv = d.inventory.map(i => ({...i, id: String(i.id).trim()}));
                            const uniqueCloudInv = deduplicateInventory(safeInv);
                            setInventory(uniqueCloudInv);
                            setTransactions(d.transactions);
                            if(d.logs) {
                                setInventoryLogs(d.logs);
                                saveData(STORAGE_KEYS.INV_LOGS, d.logs);
                            }
                            saveData(STORAGE_KEYS.INVENTORY, uniqueCloudInv);
                            saveData(STORAGE_KEYS.TRANSACTIONS, d.transactions);
                            if(d.logo) {
                                setLogo(d.logo);
                                saveData(STORAGE_KEYS.LOGO, d.logo);
                            }
                        }
                    });
                }
            }, []);

            const updateStock = (newInv, newTx, newLogs) => {
                setInventory(newInv); saveData(STORAGE_KEYS.INVENTORY, newInv);
                const txs = newTx ? (newTx.length !== undefined ? newTx : transactions) : transactions;
                if(newTx) { setTransactions(txs); saveData(STORAGE_KEYS.TRANSACTIONS, txs); }
                syncSheets(settings.sheetUrl, newInv, txs, newLogs || inventoryLogs, logo);
            };

            const handleCheckout = (name, dept, itemId, qty, method) => {
                const item = inventory.find(i => i.id === itemId);
                if (!item) return;
                const newInv = inventory.map(i => i.id === itemId ? { ...i, quantity: Math.max(0, i.quantity - qty), lastUpdated: new Date().toISOString() } : i);
                const newTx = { id: Date.now(), employeeName: name, department: dept, items: [{ itemName: item.name, quantity: qty }], timestamp: new Date().toISOString(), method };
                updateStock(newInv, [newTx, ...transactions], inventoryLogs);
                showNotif('Checkout Success');
                setCoData({ ...coData, item: '', qty: '1' });
            };

            const handleAiCheckout = async (e) => {
                e.preventDefault();
                if(!settings.apiKey) return alert("Please set API Key in Settings first.");
                setAiLoading(true);
                try {
                    const invList = inventory.map(i => `- ${i.name}`).join("\n");
                    const sys = `Extract JSON: { "employeeName": "string", "department": "string (optional)", "items": [{"itemNameTarget": "exact string from list", "quantity": number}] }. Inventory: \n${invList}`;
                    const res = await callGemini(settings.apiKey, aiPrompt, sys);
                    const data = JSON.parse(res.candidates[0].content.parts[0].text);
                    if(data.items) {
                        data.items.forEach(req => {
                            const found = inventory.find(i => i.name === req.itemNameTarget);
                            if (found) handleCheckout(data.employeeName || 'Unknown', data.department || 'General', found.id, req.quantity, 'AI');
                        });
                        setAiPrompt('');
                    }
                } catch (e) { alert("AI Error: " + e.message); }
                setAiLoading(false);
            };

            const saveItem = (item) => {
                const safeId = String(item.id).trim();
                const existingIdx = inventory.findIndex(i => String(i.id).trim() === safeId);
                
                let newInv;
                let currentLogs = inventoryLogs;

                if (existingIdx >= 0) {
                    const old = inventory[existingIdx];
                    let changes = [];
                    if(old.quantity !== item.quantity) changes.push(`Qty: ${old.quantity} -> ${item.quantity}`);
                    if(old.name !== item.name) changes.push(`Name: ${old.name} -> ${item.name}`);
                    if(changes.length === 0) changes.push("Updated details");
                    
                    currentLogs = addLog('UPDATE', item.name, changes.join(', '));
                    newInv = [...inventory];
                    newInv[existingIdx] = { ...item, id: safeId }; 
                } else {
                    currentLogs = addLog('CREATE', item.name, `Initial Qty: ${item.quantity}`);
                    newInv = [...inventory, { ...item, id: safeId }];
                }
                
                updateStock(newInv, undefined, currentLogs);
                setModalOpen(false);
                setEditItem(null);
                showNotif('Item Saved');
            };

            const deleteItem = (id) => {
                if(!confirm("Delete?")) return;
                const safeId = String(id).trim();
                const item = inventory.find(i => String(i.id).trim() === safeId);
                if(item) {
                    const currentLogs = addLog('DELETE', item.name, 'Item removed from database');
                    updateStock(inventory.filter(i => String(i.id).trim() !== safeId), undefined, currentLogs);
                    showNotif('Item Deleted');
                }
            };

            const saveTx = (tx) => {
                const newTx = transactions.map(t => t.id === tx.id ? tx : t);
                updateStock(inventory, newTx);
                setTxModalOpen(false);
                showNotif('Log Updated');
            };

            const deleteTx = (id) => {
                if(!confirm("Delete this transaction log? Inventory will NOT be restored.")) return;
                const newTx = transactions.filter(t => t.id !== id);
                updateStock(inventory, newTx);
                showNotif('Log Deleted');
            };

            const handleImport = (importedInv, importedHist) => {
                if (importedInv) {
                    const combined = [...inventory, ...importedInv];
                    const uniqueInv = deduplicateInventory(combined);
                    // Log bulk import
                    const currentLogs = addLog('UPDATE', 'Bulk Import', `Imported ${importedInv.length} items`);
                    updateStock(uniqueInv, undefined, currentLogs);
                }
                if (importedHist) {
                    const newTx = [...transactions, ...importedHist];
                    updateStock(inventory, newTx);
                }
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const MAX_SIZE = 128;
                            let w = img.width;
                            let h = img.height;
                            if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } }
                            else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
                            canvas.width = w;
                            canvas.height = h;
                            ctx.drawImage(img, 0, 0, w, h);
                            const base64 = canvas.toDataURL('image/png');
                            setLogo(base64);
                            localStorage.setItem(STORAGE_KEYS.LOGO, base64);
                            showNotif('Logo Updated & Resized');
                        };
                        img.src = reader.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const filteredTransactions = transactions.filter(t => 
                t.employeeName.toLowerCase().includes(txSearch.toLowerCase()) || 
                (t.department && t.department.toLowerCase().includes(txSearch.toLowerCase())) ||
                t.items.some(i => i.itemName.toLowerCase().includes(txSearch.toLowerCase()))
            );

            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-slate-50 text-slate-800">
                    <aside className="bg-slate-900 text-white w-full md:w-64 p-4 flex flex-col shrink-0">
                        <div className="mb-8 px-2 py-4 flex items-center gap-3">
                            <label className="relative cursor-pointer group logo-hover">
                                <img 
                                    src={logo || `https://ui-avatars.com/api/?name=GC&background=f97316&color=fff&size=128&bold=true`} 
                                    className="w-10 h-10 rounded-full bg-white object-contain border-2 border-safety-500" 
                                    alt="Logo"
                                />
                                <div className="logo-edit absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 transition-opacity">
                                    <Icons.Camera className="text-white w-4 h-4" />
                                </div>
                                <input type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} />
                            </label>
                            <div>
                                <div className="font-bold text-base text-safety-500 leading-tight">Gold Coin Bekasi</div>
                                <div className="text-[10px] text-slate-500 uppercase tracking-wider">PPE Database</div>
                            </div>
                        </div>
                        <nav className="flex-1 space-y-2">
                            {[
                                {id:'DASHBOARD', icon: Icons.Dashboard},
                                {id:'INVENTORY', icon: Icons.List},
                                {id:'HISTORY', icon: Icons.History},
                                {id:'TRACKER', icon: Icons.User},
                                {id:'SETTINGS', icon: Icons.Settings}
                            ].map(item => (
                                <button key={item.id} onClick={()=>setView(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-medium ${view===item.id?'bg-safety-600':'text-slate-400 hover:bg-slate-800'}`}>
                                    <item.icon /> {item.id.charAt(0)+item.id.slice(1).toLowerCase()}
                                </button>
                            ))}
                        </nav>
                        <div className="pt-4 border-t border-slate-800 space-y-2">
                            <button onClick={()=>setQrOpen(true)} className="flex gap-2 text-xs text-slate-400 w-full px-4 py-2 hover:bg-slate-800 rounded"><Icons.Qr/> Mobile Access</button>
                            <button onClick={()=>{doCloudSync();}} className="flex gap-2 text-xs text-green-400 w-full px-4 py-2 hover:bg-slate-800 rounded"><Icons.Refresh/> Quick Sync</button>
                        </div>
                    </aside>

                    <main className="flex-1 p-4 md:p-8 overflow-y-auto">
                        <div className="max-w-6xl mx-auto">
                            {view === 'DASHBOARD' && 
                                <DashboardView 
                                    inventory={inventory} 
                                    coTab={coTab} setCoTab={setCoTab}
                                    coData={coData} setCoData={setCoData}
                                    aiPrompt={aiPrompt} setAiPrompt={setAiPrompt}
                                    aiLoading={aiLoading}
                                    handleCheckout={handleCheckout}
                                    handleAiCheckout={handleAiCheckout}
                                />
                            }
                            {view === 'INVENTORY' && 
                                <InventoryView 
                                    inventory={inventory}
                                    logs={inventoryLogs}
                                    setEditItem={setEditItem}
                                    setModalOpen={setModalOpen}
                                    deleteItem={deleteItem}
                                />
                            }
                            {view === 'HISTORY' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                        <h2 className="text-xl font-bold">Transaction History</h2>
                                        <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                                             <div className="relative">
                                                <Icons.Search className="absolute left-3 top-2.5 text-slate-400 w-4 h-4"/>
                                                <input 
                                                    type="text"
                                                    autoComplete="off"
                                                    autoCorrect="off"
                                                    spellCheck="false"
                                                    className="w-full sm:w-64 pl-9 p-2 border rounded text-sm" 
                                                    placeholder="Search logs..." 
                                                    value={txSearch}
                                                    onChange={e => setTxSearch(e.target.value)}
                                                />
                                            </div>
                                            <button onClick={()=>exportToExcel(transactions, 'HISTORY')} className="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded flex items-center justify-center gap-2 hover:bg-emerald-700 shadow-sm"><Icons.Excel/> Export Table</button>
                                        </div>
                                    </div>
                                    {filteredTransactions.map((t,i)=>(
                                        <div key={t.id} className="bg-white p-4 rounded border flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 hover:shadow-sm transition-shadow">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-bold">{t.employeeName}</span>
                                                    <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500 border">{t.department || 'General'}</span>
                                                </div>
                                                <div className="text-xs text-slate-400 mt-1">{new Date(t.timestamp).toLocaleString()} &bull; {t.method}</div>
                                            </div>
                                            <div className="text-left sm:text-right flex-1">{t.items.map((x,k)=><div key={k}>{x.itemName} <span className="font-bold text-red-600">-{x.quantity}</span></div>)}</div>
                                            <div className="flex gap-2 relative z-10 w-full sm:w-auto justify-end">
                                                <button type="button" onClick={()=>{setEditTx(t); setTxModalOpen(true);}} className="text-slate-400 hover:text-indigo-600 p-2 hover:bg-slate-100 rounded transition-colors" title="Edit"><Icons.Edit/></button>
                                                <button type="button" onClick={()=>deleteTx(t.id)} className="text-slate-400 hover:text-red-600 p-2 hover:bg-slate-100 rounded transition-colors" title="Delete"><Icons.Trash/></button>
                                            </div>
                                        </div>
                                    ))}
                                    {filteredTransactions.length===0 && <div className="text-center text-slate-400 p-8">No records found.</div>}
                                </div>
                            )}
                            {view === 'TRACKER' && <PersonalTrackerView transactions={transactions} />}
                            {view === 'SETTINGS' && 
                                <SettingsView 
                                    settings={settings} setSettings={setSettings}
                                    saveData={saveData} showNotif={showNotif}
                                    doCloudSync={doCloudSync}
                                    inventory={inventory}
                                    transactions={transactions}
                                    logs={inventoryLogs}
                                    onImport={handleImport}
                                />
                            }
                        </div>
                    </main>
                    
                    {notify && <div className="fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded shadow-lg animate-bounce z-50">{notify}</div>}
                    
                    <InventoryModal 
                        key={modalOpen ? (editItem ? editItem.id : 'new') : 'closed'}
                        isOpen={modalOpen} 
                        onClose={()=>setModalOpen(false)} 
                        initialData={editItem} 
                        onSave={saveItem} 
                    />
                    
                    <TransactionModal isOpen={txModalOpen} onClose={()=>setTxModalOpen(false)} initialData={editTx} onSave={saveTx} />

                    {qrOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setQrOpen(false)}>
                            <div className="bg-white p-6 rounded-xl shadow-xl text-center" onClick={e=>e.stopPropagation()}>
                                <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.href)}`} className="mx-auto border p-2 rounded mb-4"/>
                                <p className="text-sm text-slate-500">Scan to open on phone.</p>
                                <p className="text-xs text-red-500 mt-2">Must set up Google Sheets for data sync.</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
