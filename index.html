<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Coin Bekasi HSE Portal</title>
    
    <!-- Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('root').innerHTML = `
                <div style="color: #b91c1c; background: #fef2f2; padding: 20px; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                    <h1 style="font-size: 24px; margin-bottom: 10px;">⚠️ App Error</h1>
                    <p><strong>${msg}</strong></p>
                    <button onclick="localStorage.clear(); window.location.reload()" style="margin-top:20px; background: #dc2626; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Reset Data</button>
                </div>
            `;
            return false;
        };
    </script>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .logo-hover:hover .logo-edit { opacity: 1; }
        .map-marker { transition: transform 0.2s ease; transform-origin: center center; }
        .map-marker:hover { z-index: 50; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* Accordion transition */
        .sub-menu { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; }
        .sub-menu.open { max-height: 500px; opacity: 1; }
    </style>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        safety: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c', 700: '#c2410c' }
                    }
                }
            }
        }
    </script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONFIGURATION ---
        const DEFAULT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwiQzTXUQ8qBIAqoRIn7FrAXcyAgVLmIYiKMZAz1q6rBXfGrgmpYBcMdptHbbdChO_U/exec"; 
        const DEFAULT_MAP_URL = "https://ik.imagekit.io/DannyMD27/Bekasi%20Mill%20Layout.png?updatedAt=1764841975885"; 

        // --- ICONS ---
        const Icons = {
            Dashboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3"/><rect width="7" height="5" x="14" y="3"/><rect width="7" height="9" x="14" y="12"/><rect width="7" height="5" x="3" y="16"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Qr: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M16 16l-2.74 2.74"/><path d="M21 21v-5h-5"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            CloudUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/><polyline points="12 13 12 21"/><polyline points="9 16 12 13 15 16"/></svg>,
            Excel: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>,
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Map: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>,
            FireExtinguisher: (props) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" {...props}><path d="M7 7h10v2H7z" opacity=".5"/><path d="M12 2c-1.1 0-2 .9-2 2v2H8c-1.1 0-2 .9-2 2v2h12V8c0-1.1-.9-2-2-2h-2V4c0-1.1-.9-2-2-2zm-5 9v9c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2v-9H7z"/></svg>,
            // NEW ICONS
            File: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
            Video: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
            Image: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            HardHat: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12h20"/><path d="M6 12V7a6 6 0 0 1 12 0v5"/><path d="M4 17h16"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M8 5v14l11-7z"/></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Menu: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
        };

        // --- CONSTANTS ---
        const STORAGE_KEYS = { 
            INVENTORY: 'ppe_inv', TRANSACTIONS: 'ppe_tx', INV_LOGS: 'ppe_inv_logs', 
            SETTINGS: 'ppe_set', LOGO: 'ppe_logo', MAP_IMG: 'ppe_map_img', 
            MAP_MARKERS: 'ppe_map_markers', DOCS: 'hse_docs', GALLERY: 'hse_gallery'
        };
        
        // --- SERVICES ---
        const safeParse = (key, fallback) => { try { return JSON.parse(localStorage.getItem(key)) || fallback; } catch { return fallback; } };
        const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        
        // Validate Image Data URL
        const isValidLogo = (str) => {
            return typeof str === 'string' && str.startsWith('data:image') && str.length > 50;
        };

        // NEW: Deduplication Logic
        const deduplicateInventory = (items) => {
            const map = new Map();
            items.forEach(item => {
                const id = String(item.id).trim();
                // If ID exists, keep the one with the LATEST lastUpdated date
                if (!map.has(id)) {
                    map.set(id, { ...item, id });
                } else {
                    const existing = map.get(id);
                    // If current item is newer than existing, replace it
                    if (new Date(item.lastUpdated) > new Date(existing.lastUpdated)) {
                        map.set(id, { ...item, id });
                    }
                }
            });
            return Array.from(map.values());
        };

        const syncSheets = async (url, dataPkg) => {
            if(!url) return;
            try { 
                await fetch(url, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'text/plain;charset=utf-8'}, 
                    body: JSON.stringify({ action: 'SYNC', ...dataPkg }) 
                }); 
            } catch(e) { console.log('Sync error', e); }
        };

        const fetchSheets = async (url) => {
            if(!url) return null;
            try {
                // ADDED: Cache buster &t=... to prevent browser from serving old data
                const res = await fetch(`${url}?action=GET_DATA&t=${Date.now()}`);
                const data = await res.json();
                return data.status === 'success' ? data : null;
            } catch(e) { 
                console.error("Fetch Error:", e);
                return null; 
            }
        };

        const callGemini = async (apiKey, prompt, systemInstruction) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    system_instruction: { parts: [{ text: systemInstruction }] },
                    generationConfig: { response_mime_type: "application/json" }
                })
            });
            const data = await response.json();
            if(data.error) throw new Error(data.error.message);
            return data;
        };

        const exportToExcel = (data, type) => {
            let html = '';
            if (type === 'INVENTORY') {
                html = `
                    <table border="1">
                        <thead>
                            <tr style="background-color: #cccccc; font-weight: bold;">
                                <th style="width: 50px;">No</th>
                                <th style="width: 200px;">Name of the PPE</th>
                                <th style="width: 100px;">Quantity</th>
                                <th style="width: 100px;">Category</th>
                                <th style="width: 80px;">Unit</th>
                                <th style="width: 150px;">Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((item, index) => `
                                <tr>
                                    <td style="text-align: center;">${index + 1}</td>
                                    <td>${item.name}</td>
                                    <td style="text-align: center;">${item.quantity}</td>
                                    <td>${item.category}</td>
                                    <td style="text-align: center;">${item.unit}</td>
                                    <td>${new Date(item.lastUpdated).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (type === 'HISTORY') {
                html = `
                    <table border="1">
                        <thead>
                            <tr style="background-color: #cccccc; font-weight: bold;">
                                <th style="width: 50px;">No</th>
                                <th style="width: 100px;">Date</th>
                                <th style="width: 100px;">Time</th>
                                <th style="width: 150px;">Employee Name</th>
                                <th style="width: 150px;">Department</th>
                                <th style="width: 200px;">Items Taken</th>
                                <th style="width: 80px;">Method</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((tx, index) => `
                                <tr>
                                    <td style="text-align: center;">${index + 1}</td>
                                    <td>${new Date(tx.timestamp).toLocaleDateString()}</td>
                                    <td>${new Date(tx.timestamp).toLocaleTimeString()}</td>
                                    <td>${tx.employeeName}</td>
                                    <td>${tx.department || '-'}</td>
                                    <td>${tx.items.map(i => `${i.quantity}x ${i.itemName}`).join(', ')}</td>
                                    <td>${tx.method}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else if (type === 'LOGS') {
                 html = `
                    <table border="1">
                        <thead>
                            <tr style="background-color: #cccccc; font-weight: bold;">
                                <th style="width: 50px;">No</th>
                                <th style="width: 100px;">Date</th>
                                <th style="width: 100px;">Time</th>
                                <th style="width: 80px;">Action</th>
                                <th style="width: 150px;">Item Name</th>
                                <th style="width: 200px;">Change Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((log, index) => `
                                <tr>
                                    <td style="text-align: center;">${index + 1}</td>
                                    <td>${new Date(log.timestamp).toLocaleDateString()}</td>
                                    <td>${new Date(log.timestamp).toLocaleTimeString()}</td>
                                    <td>${log.action}</td>
                                    <td>${log.itemName}</td>
                                    <td>${log.changeDetails}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            
            const blob = new Blob(['\ufeff', html], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GoldCoin_${type}_${new Date().toISOString().split('T')[0]}.xls`;
            a.click();
        };

        // --- COMPONENTS ---

        const SimpleChart = ({ data }) => {
            // Sort: Low stock first, then alphabetically
            const sorted = useMemo(() => {
                return [...data].sort((a, b) => {
                    // Sort by status (low stock first)
                    const aLow = a.quantity <= a.threshold;
                    const bLow = b.quantity <= b.threshold;
                    if (aLow && !bLow) return -1;
                    if (!aLow && bLow) return 1;
                    // Then by name
                    return a.name.localeCompare(b.name);
                });
            }, [data]);

            if (data.length === 0) return <div className="p-4 text-center text-slate-400 text-sm">No inventory data available.</div>;

            return (
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-[400px] overflow-y-auto pr-1">
                    {sorted.map(i => {
                        const isLow = i.quantity <= i.threshold;
                        // Determine progress bar width based on quantity vs threshold
                        const safeThreshold = i.threshold || 1;
                        const pct = Math.min(100, (i.quantity / (safeThreshold * 3)) * 100);

                        return (
                            <div key={i.id} className={`p-3 rounded-lg border flex flex-col justify-between ${isLow ? 'bg-red-50 border-red-200 shadow-sm' : 'bg-white border-slate-100 hover:border-slate-300'}`}>
                                <div className="flex justify-between items-start mb-2 gap-2">
                                    <div className="font-bold text-xs text-slate-700 line-clamp-2 leading-tight" title={i.name}>{i.name}</div>
                                    {isLow && <div className="w-2 h-2 rounded-full bg-red-500 shrink-0 animate-pulse"></div>}
                                </div>
                                <div>
                                    <div className="flex items-baseline justify-between mb-1">
                                        <span className={`text-xl font-bold leading-none ${isLow ? 'text-red-600' : 'text-slate-800'}`}>{i.quantity}</span>
                                        <span className="text-[10px] text-slate-400 uppercase">{i.unit}</span>
                                    </div>
                                    
                                    <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                        <div className={`h-full rounded-full transition-all duration-500 ${isLow ? 'bg-red-500' : 'bg-emerald-500'}`} style={{ width: `${pct}%` }}></div>
                                    </div>
                                    
                                    <div className="flex justify-between items-center mt-1">
                                        <span className="text-[9px] text-slate-400">Min: {i.threshold}</span>
                                        <span className={`text-[9px] font-bold ${isLow ? 'text-red-600' : 'text-emerald-600'}`}>{isLow ? 'LOW' : 'OK'}</span>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const MapView = ({ mapImage, markers, updateMap }) => {
            const [draggingId, setDraggingId] = useState(null);
            const [editMarker, setEditMarker] = useState(null);
            const [hoveredMarker, setHoveredMarker] = useState(null);
            const [urlInput, setUrlInput] = useState('');
            const [imgError, setImgError] = useState(false);
            const containerRef = useRef(null);

            // Reset image error state when mapImage changes
            useEffect(() => {
                setImgError(false);
            }, [mapImage]);

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    // Resize image for storage efficiency
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // Limit width to 1000px to avoid hitting Google Sheet cell limits easily
                        const MAX_WIDTH = 1000;
                        let w = img.width;
                        let h = img.height;
                        if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
                        canvas.width = w;
                        canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        const base64 = canvas.toDataURL('image/jpeg', 0.6); // Medium quality compression
                        updateMap({ mapImage: base64 });
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            };

            const handleUrlSubmit = (e) => {
                e.preventDefault();
                if(urlInput) {
                    updateMap({ mapImage: urlInput });
                    setUrlInput('');
                }
            };

            const addMarker = (e) => {
                if(e.target.closest('.map-marker')) return;
                if(!mapImage || imgError) return;

                const rect = containerRef.current.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;

                const newMarker = {
                    id: Date.now(),
                    name: 'APAR-' + Math.floor(Math.random()*100),
                    type: 'Powder',
                    expiry: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0],
                    x, y
                };
                const updated = [...markers, newMarker];
                updateMap({ markers: updated });
            };

            const handleMouseMove = (e) => {
                if (draggingId && containerRef.current) {
                    const rect = containerRef.current.getBoundingClientRect();
                    const x = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
                    const y = Math.max(0, Math.min(100, ((e.clientY - rect.top) / rect.height) * 100));
                }
            };
            
            const [localMarkers, setLocalMarkers] = useState(markers);
            
            useEffect(() => {
                setLocalMarkers(markers);
            }, [markers]);

            const handleLocalMove = (e) => {
                 if (draggingId && containerRef.current) {
                    const rect = containerRef.current.getBoundingClientRect();
                    const x = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
                    const y = Math.max(0, Math.min(100, ((e.clientY - rect.top) / rect.height) * 100));
                    setLocalMarkers(localMarkers.map(m => m.id === draggingId ? { ...m, x, y } : m));
                }
            };

            const handleMouseUp = () => {
                if(draggingId) {
                    updateMap({ markers: localMarkers });
                    setDraggingId(null);
                }
            };

            const saveMarkerDetails = (id, name, type, expiry) => {
                const updated = localMarkers.map(m => m.id === id ? { ...m, name, type, expiry } : m);
                updateMap({ markers: updated });
                setEditMarker(null);
            };

            const deleteMarker = (id) => {
                if(confirm("Remove this extinguisher?")) {
                    const updated = localMarkers.filter(m => m.id !== id);
                    updateMap({ markers: updated });
                    setEditMarker(null);
                }
            };

            const resetMap = () => {
                if(confirm("Reset map to default configuration?")) {
                    setImgError(false);
                    updateMap({ mapImage: DEFAULT_MAP_URL });
                }
            };

            return (
                <div className="space-y-4 animate-fade-in" onMouseUp={handleMouseUp} onMouseLeave={handleMouseUp}>
                    <div className="flex flex-col xl:flex-row justify-between items-start xl:items-center bg-white p-4 rounded border shadow-sm gap-4">
                        <div className="flex items-center gap-2">
                            <h2 className="text-xl font-bold">Facility Map</h2>
                            <span className="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded hidden sm:inline-block">Click map to add &bull; Drag to move</span>
                        </div>
                        <div className="flex flex-col sm:flex-row gap-2 w-full xl:w-auto">
                            <form onSubmit={handleUrlSubmit} className="flex gap-2 flex-1">
                                <input 
                                    className="p-2 border rounded text-sm flex-1 min-w-[150px]" 
                                    placeholder="Paste Image URL here..."
                                    value={urlInput}
                                    onChange={e=>setUrlInput(e.target.value)}
                                />
                                <button className="bg-slate-200 text-slate-700 px-3 py-2 rounded font-bold text-sm hover:bg-slate-300">Set URL</button>
                            </form>
                            <label className="bg-indigo-600 text-white px-4 py-2 rounded font-bold cursor-pointer hover:bg-indigo-700 flex gap-2 items-center text-sm w-full sm:w-auto justify-center whitespace-nowrap">
                                <Icons.Upload className="w-4 h-4" /> {mapImage ? "Change File" : "Upload File"}
                                <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
                            </label>
                            <button onClick={resetMap} className="bg-slate-100 text-slate-600 px-4 py-2 rounded font-bold hover:bg-slate-200 text-sm w-full sm:w-auto">
                                Reset
                            </button>
                        </div>
                    </div>

                    <div className="bg-white p-4 rounded border shadow-sm overflow-hidden relative min-h-[500px] flex items-center justify-center bg-slate-100">
                        {(!mapImage) ? (
                            <div className="text-slate-400 text-center max-w-sm">
                                <Icons.Map className="w-16 h-16 mx-auto mb-2 opacity-20"/>
                                <p className="font-bold mb-2">No Map Loaded</p>
                                <p className="text-sm">Upload an image or paste a URL above.</p>
                                <button onClick={resetMap} className="mt-4 text-indigo-600 font-bold underline">Load Default Map</button>
                            </div>
                        ) : (
                            <div 
                                ref={containerRef}
                                className="relative w-full shadow-lg cursor-crosshair select-none"
                                onClick={addMarker}
                                onMouseMove={handleLocalMove}
                            >
                                <img 
                                    src={mapImage} 
                                    className={`w-full h-auto block pointer-events-none ${imgError ? 'opacity-0' : 'opacity-100'}`} 
                                    alt="Map" 
                                    onError={(e) => {
                                        console.error("Map Image Load Error:", mapImage);
                                        setImgError(true);
                                    }}
                                />
                                {imgError && (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-100 text-center p-6 z-10">
                                        <Icons.Map className="w-16 h-16 text-slate-300 mb-4" />
                                        <h3 className="text-red-600 font-bold text-lg mb-2">Failed to Load Map Image</h3>
                                        <p className="text-sm text-slate-500 max-w-md mb-4 break-all">
                                            The URL could not be loaded: <br/>{mapImage.substring(0, 50)}...
                                        </p>
                                        <div className="flex gap-2">
                                            <button onClick={resetMap} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700">Reset to Default</button>
                                            <button onClick={()=>setImgError(false)} className="bg-slate-200 text-slate-700 px-4 py-2 rounded font-bold hover:bg-slate-300">Retry</button>
                                        </div>
                                    </div>
                                )}
                                
                                {!imgError && localMarkers.map(m => {
                                    const isExpired = new Date(m.expiry) < new Date();
                                    return (
                                        <div
                                            key={m.id}
                                            className="map-marker absolute -translate-x-1/2 -translate-y-1/2 cursor-grab active:cursor-grabbing"
                                            style={{ left: `${m.x}%`, top: `${m.y}%`, zIndex: hoveredMarker?.id === m.id ? 50 : 10 }}
                                            onMouseDown={(e) => { e.stopPropagation(); setDraggingId(m.id); setHoveredMarker(null); }}
                                            onClick={(e) => { e.stopPropagation(); setEditMarker(m); }}
                                            onMouseEnter={() => !draggingId && setHoveredMarker(m)}
                                            onMouseLeave={() => setHoveredMarker(null)}
                                        >
                                            <div className={`p-0.5 rounded-full shadow-sm border transition-transform hover:scale-125 ${isExpired ? 'bg-amber-100 border-red-500 animate-pulse' : 'bg-white border-slate-200'}`}>
                                                <Icons.FireExtinguisher className="w-4 h-4 text-red-600" />
                                            </div>
                                        </div>
                                    );
                                })}

                                {!imgError && hoveredMarker && !draggingId && (
                                    <div 
                                        className="absolute z-50 bg-slate-800/95 backdrop-blur-sm text-white text-xs rounded-lg p-3 shadow-xl pointer-events-none w-48 border border-slate-600"
                                        style={{
                                            left: hoveredMarker.x <= 50 ? `${hoveredMarker.x}%` : 'auto',
                                            right: hoveredMarker.x > 50 ? `${100 - hoveredMarker.x}%` : 'auto',
                                            top: hoveredMarker.y <= 50 ? `${hoveredMarker.y}%` : 'auto',
                                            bottom: hoveredMarker.y > 50 ? `${100 - hoveredMarker.y}%` : 'auto',
                                            transform: `translate(${hoveredMarker.x <= 50 ? '16px' : '-16px'}, ${hoveredMarker.y <= 50 ? '16px' : '-16px'})`
                                        }}
                                    >
                                        <div className="font-bold text-amber-400 text-sm mb-2 border-b border-slate-600 pb-1">{hoveredMarker.name || 'APAR'}</div>
                                        <div className="space-y-1">
                                            <div className="flex justify-between"><span className="text-slate-400">Type</span><span className="font-medium">{hoveredMarker.type}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-400">Expiry</span><span className="font-medium font-mono">{hoveredMarker.expiry}</span></div>
                                        </div>
                                        {new Date(hoveredMarker.expiry) < new Date() && (
                                            <div className="mt-2 bg-red-900/50 text-red-200 text-center py-1 rounded border border-red-800 font-bold uppercase text-[10px] tracking-wider">
                                                ⚠️ Expired
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    
                    <div className="bg-white p-4 rounded border flex flex-col sm:flex-row gap-6 text-sm items-center">
                        <span className="font-bold text-slate-500 uppercase text-xs">Map Legend:</span>
                        <div className="flex items-center gap-2">
                             <div className="p-0.5 bg-white border border-slate-200 rounded shadow-sm">
                                <Icons.FireExtinguisher className="w-4 h-4 text-red-600" />
                            </div>
                            <span className="font-medium text-slate-700">Fire Extinguisher (APAR)</span>
                        </div>
                        <div className="flex items-center gap-2">
                             <div className="p-0.5 bg-amber-100 border border-red-500 rounded shadow-sm animate-pulse">
                                <Icons.FireExtinguisher className="w-4 h-4 text-red-600" />
                            </div>
                            <span className="font-medium text-red-600">Expired / Needs Inspection</span>
                        </div>
                    </div>

                    {editMarker && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setEditMarker(null)}>
                            <div className="bg-white p-6 rounded-xl shadow-xl w-full max-w-sm animate-fade-in" onClick={e => e.stopPropagation()}>
                                <h3 className="font-bold text-lg mb-4">Edit Extinguisher</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">NAME / ID</label>
                                        <input className="w-full p-2 border rounded" defaultValue={editMarker.name || 'APAR'} id="marker-name" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">TYPE</label>
                                        <select className="w-full p-2 border rounded" defaultValue={editMarker.type} id="marker-type">
                                            <option>Powder</option><option>CO2</option><option>Foam</option><option>Water</option><option>Wet Chemical</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">EXPIRY DATE</label>
                                        <input type="date" className="w-full p-2 border rounded" defaultValue={editMarker.expiry} id="marker-expiry" />
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={() => deleteMarker(editMarker.id)} className="flex-1 bg-red-100 text-red-700 py-2 rounded font-bold hover:bg-red-200">Remove</button>
                                        <button onClick={() => saveMarkerDetails(editMarker.id, document.getElementById('marker-name').value, document.getElementById('marker-type').value, document.getElementById('marker-expiry').value)} className="flex-1 bg-safety-600 text-white py-2 rounded font-bold hover:bg-safety-700">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const SearchableSelect = ({ items, value, onChange, placeholder }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState('');
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            // FIX: Ensure ID comparison is string vs string
            const selectedItem = items.find(i => String(i.id).trim() === String(value).trim());
            
            const filteredItems = useMemo(() => {
                let data = items || [];
                if (search.trim()) {
                    const lower = search.toLowerCase();
                    data = data.filter(item => 
                        String(item.name || '').toLowerCase().includes(lower) || 
                        String(item.category || '').toLowerCase().includes(lower)
                    );
                }
                return [...data].sort((a, b) => {
                    const nameA = String(a.name || '').toLowerCase();
                    const nameB = String(b.name || '').toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    return String(a.id || '').localeCompare(String(b.id || ''));
                });
            }, [items, search]);

            return (
                <div className="relative" ref={wrapperRef}>
                    <div 
                        className="w-full p-2 border rounded flex justify-between items-center bg-white cursor-text"
                        onClick={() => { setIsOpen(true); }}
                    >
                        {isOpen ? (
                            <input 
                                type="text"
                                autoFocus
                                autoComplete="off"
                                autoCorrect="off"
                                spellCheck="false"
                                className="w-full outline-none text-sm"
                                placeholder="Type to search..."
                                value={search}
                                onChange={e => setSearch(e.target.value)}
                                onKeyDown={e => { if(e.key === 'Enter') e.preventDefault(); }}
                            />
                        ) : (
                            <span className={`text-sm ${!selectedItem ? "text-slate-400" : "text-slate-800"}`}>
                                {selectedItem ? `${selectedItem.name} (${selectedItem.quantity})` : placeholder}
                            </span>
                        )}
                        <Icons.Search className="w-4 h-4 text-slate-400"/>
                    </div>
                    
                    {isOpen && (
                        <div className="absolute z-50 w-full bg-white border rounded shadow-lg max-h-60 overflow-auto mt-1">
                            {filteredItems.length > 0 ? filteredItems.map((item, index) => (
                                <div 
                                    key={`${item.id}-${index}`}
                                    className={`p-2 hover:bg-slate-100 cursor-pointer ${item.quantity === 0 ? 'opacity-50' : ''}`}
                                    onClick={() => {
                                        if(item.quantity > 0) {
                                            onChange(item.id);
                                            setIsOpen(false);
                                            setSearch('');
                                        }
                                    }}
                                >
                                    <div className="font-bold text-sm">{item.name}</div>
                                    <div className="text-xs text-slate-500">Qty: {item.quantity} • {item.category}</div>
                                </div>
                            )) : (
                                <div className="p-2 text-sm text-slate-500 text-center">No items found</div>
                            )}
                        </div>
                    )}
                </div>
            )
        };

        const InventoryModal = ({ isOpen, onClose, initialData, onSave }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6 animate-fade-in" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">{initialData ? 'Edit Item' : 'Add Item'}</h3>
                            <button onClick={onClose} className="text-slate-400 font-bold text-xl">&times;</button>
                        </div>
                        <form onSubmit={(e)=>{
                            e.preventDefault();
                            const fd = new FormData(e.target);
                            // FIXED: Use the ID from the hidden input to ensure we don't generate a new one during edit
                            const formId = fd.get('obj_id');
                            const finalId = (formId && formId !== '') ? String(formId) : Date.now().toString();

                            onSave({
                                id: finalId,
                                name: fd.get('name'),
                                category: fd.get('category'),
                                quantity: Number(fd.get('quantity')),
                                unit: fd.get('unit'),
                                threshold: Number(fd.get('threshold')),
                                lastUpdated: new Date().toISOString()
                            });
                        }} className="space-y-4">
                            {/* HIDDEN INPUT FOR ID PERSISTENCE */}
                            <input type="hidden" name="obj_id" defaultValue={initialData ? initialData.id : ''} />
                            
                            <div><label className="text-xs font-bold text-slate-500">NAME</label><input name="name" className="w-full p-2 border rounded" required defaultValue={initialData?.name}/></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-slate-500">CATEGORY</label><select name="category" className="w-full p-2 border rounded" defaultValue={initialData?.category||'General'}><option>Head</option><option>Eye</option><option>Hand</option><option>Foot</option><option>Apparel</option><option>General</option></select></div>
                                <div><label className="text-xs font-bold text-slate-500">UNIT</label><input name="unit" className="w-full p-2 border rounded" defaultValue={initialData?.unit||'pcs'}/></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-slate-500">QTY</label><input name="quantity" type="number" className="w-full p-2 border rounded" required defaultValue={initialData?.quantity||0}/></div>
                                <div><label className="text-xs font-bold text-slate-500">LIMIT</label><input name="threshold" type="number" className="w-full p-2 border rounded" defaultValue={initialData?.threshold||5}/></div>
                            </div>
                            <button className="w-full bg-safety-600 text-white py-2 rounded font-bold hover:bg-safety-700">Save Item</button>
                        </form>
                    </div>
                </div>
            );
        };

        const TransactionModal = ({ isOpen, onClose, initialData, onSave }) => {
            if(!isOpen || !initialData) return null;
            const dateObj = new Date(initialData.timestamp);
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6 animate-fade-in" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">Edit Log</h3>
                            <button onClick={onClose} className="text-slate-400 font-bold text-xl">&times;</button>
                        </div>
                        <div className="mb-4 text-xs text-amber-600 bg-amber-50 p-2 rounded border border-amber-200">
                            Editing details does not revert inventory quantities.
                        </div>
                        <form onSubmit={(e)=>{
                            e.preventDefault();
                            const fd = new FormData(e.target);
                            onSave({
                                ...initialData,
                                employeeName: fd.get('employeeName'),
                                department: fd.get('department'),
                                timestamp: new Date(fd.get('date') + 'T' + fd.get('time')).toISOString()
                            });
                        }} className="space-y-4">
                            <div><label className="text-xs font-bold text-slate-500">EMPLOYEE</label><input name="employeeName" className="w-full p-2 border rounded" required defaultValue={initialData.employeeName}/></div>
                            <div>
                                <label className="text-xs font-bold text-slate-500">DEPARTMENT</label>
                                <input name="department" list="depts-modal" className="w-full p-2 border rounded" defaultValue={initialData.department||''}/>
                                <datalist id="depts-modal"><option value="Production"/><option value="Logistics"/><option value="Warehouse"/><option value="Engineering"/><option value="Office"/></datalist>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-slate-500">DATE</label><input type="date" name="date" className="w-full p-2 border rounded" required defaultValue={dateObj.toISOString().split('T')[0]}/></div>
                                <div><label className="text-xs font-bold text-slate-500">TIME</label><input type="time" name="time" className="w-full p-2 border rounded" required defaultValue={dateObj.toTimeString().slice(0,5)}/></div>
                            </div>
                            <button className="w-full bg-safety-600 text-white py-2 rounded font-bold hover:bg-safety-700">Update Log</button>
                        </form>
                    </div>
                </div>
            );
        };

        const PersonalTrackerView = ({ transactions }) => {
            const [selectedEmployee, setSelectedEmployee] = useState('');
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM

            const employees = useMemo(() => {
                return Array.from(new Set(transactions.map(t => t.employeeName))).sort();
            }, [transactions]);

            const stats = useMemo(() => {
                if (!selectedEmployee || !month) return { total: 0, items: {}, list: [] };

                const [y, m] = month.split('-');
                const targetDate = new Date(Number(y), Number(m) - 1);
                
                const filtered = transactions.filter(t => {
                    const d = new Date(t.timestamp);
                    return t.employeeName === selectedEmployee && 
                        d.getMonth() === targetDate.getMonth() && 
                        d.getFullYear() === targetDate.getFullYear();
                });

                const itemCounts = {};
                filtered.forEach(t => {
                    t.items.forEach(i => {
                        itemCounts[i.itemName] = (itemCounts[i.itemName] || 0) + i.quantity;
                    });
                });

                return {
                    total: filtered.reduce((acc, t) => acc + t.items.reduce((s, i) => s + i.quantity, 0), 0),
                    items: itemCounts,
                    list: filtered
                };
            }, [transactions, selectedEmployee, month]);

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h2 className="text-xl font-bold">Personal Tracker</h2>
                    </div>
                    
                    <div className="bg-white p-6 rounded shadow border space-y-4">
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 block">SELECT EMPLOYEE</label>
                                <select 
                                    className="w-full p-2 border rounded"
                                    value={selectedEmployee}
                                    onChange={e => setSelectedEmployee(e.target.value)}
                                >
                                    <option value="">-- Select Person --</option>
                                    {employees.map(e => <option key={e} value={e}>{e}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 block">SELECT MONTH</label>
                                <input 
                                    type="month" 
                                    className="w-full p-2 border rounded"
                                    value={month}
                                    onChange={e => setMonth(e.target.value)}
                                />
                            </div>
                        </div>
                    </div>

                    {selectedEmployee && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div className="bg-white p-6 rounded shadow border">
                                <h3 className="font-bold text-lg mb-4 text-center">Summary</h3>
                                <div className="text-center mb-6">
                                    <div className="text-4xl font-bold text-safety-600">{stats.total}</div>
                                    <div className="text-xs text-slate-400 uppercase">Items Taken</div>
                                </div>
                                <div className="space-y-2">
                                    {Object.entries(stats.items).map(([name, qty]) => (
                                        <div key={name} className="flex justify-between text-sm border-b pb-1 last:border-0">
                                            <span>{name}</span>
                                            <span className="font-bold">{qty}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="lg:col-span-2 bg-white p-6 rounded shadow border">
                                <h3 className="font-bold text-lg mb-4">Transaction Details</h3>
                                {stats.list.length > 0 ? (
                                    <table className="w-full text-sm">
                                        <thead className="bg-slate-50 text-xs font-bold uppercase text-slate-500">
                                            <tr>
                                                <th className="p-2 text-left">Date</th>
                                                <th className="p-2 text-left">Items</th>
                                                <th className="p-2 text-left">Method</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {stats.list.map(t => (
                                                <tr key={t.id}>
                                                    <td className="p-2">{new Date(t.timestamp).toLocaleDateString()}</td>
                                                    <td className="p-2">
                                                        {t.items.map((i, k) => (
                                                            <span key={k} className="inline-block bg-slate-100 rounded px-2 py-1 text-xs mr-1 mb-1">
                                                                {i.quantity}x {i.itemName}
                                                            </span>
                                                        ))}
                                                    </td>
                                                    <td className="p-2 text-slate-400 text-xs">{t.method}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                ) : (
                                    <div className="text-center text-slate-400 py-8">No records for this period.</div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const DashboardView = ({ inventory, coTab, setCoTab, coData, setCoData, aiPrompt, setAiPrompt, aiLoading, handleCheckout, handleAiCheckout }) => (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
                <div className="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border h-fit">
                    <h2 className="font-bold mb-4">Quick Checkout</h2>
                    <div className="flex border-b mb-4">
                        <button onClick={()=>setCoTab('manual')} className={`flex-1 py-2 text-sm font-bold ${coTab==='manual'?'text-safety-600 border-b-2 border-safety-600':''}`}>Manual</button>
                        <button onClick={()=>setCoTab('ai')} className={`flex-1 py-2 text-sm font-bold ${coTab==='ai'?'text-indigo-600 border-b-2 border-indigo-600':''}`}>AI Voice</button>
                    </div>
                    {coTab === 'manual' ? (
                        <form onSubmit={e=>{
                                e.preventDefault(); 
                                const qty = Number(coData.qty);
                                if (!qty || qty < 1) return alert("Please enter a valid quantity");
                                handleCheckout(coData.name, coData.dept, coData.item, qty, 'MANUAL');
                            }} className="space-y-3">
                            <input className="w-full p-2 border rounded" placeholder="Employee Name" required value={coData.name} onChange={e=>setCoData({...coData, name: e.target.value})}/>
                            <input className="w-full p-2 border rounded" placeholder="Department" list="depts-dash" required value={coData.dept} onChange={e=>setCoData({...coData, dept: e.target.value})}/>
                            <datalist id="depts-dash"><option value="Production"/><option value="Logistics"/><option value="Warehouse"/><option value="Engineering"/><option value="Office"/></datalist>
                            
                            <SearchableSelect 
                                items={inventory}
                                value={coData.item}
                                onChange={val => setCoData({...coData, item: val})}
                                placeholder="Search & Select Item..."
                            />

                            <input type="number" min="1" className="w-full p-2 border rounded" required value={coData.qty} onChange={e=>setCoData({...coData, qty: e.target.value})}/>
                            <button className="w-full bg-safety-600 text-white py-2 rounded font-bold hover:bg-safety-700">Submit</button>
                        </form>
                    ) : (
                        <form onSubmit={handleAiCheckout} className="space-y-3">
                            <p className="text-xs text-indigo-600 bg-indigo-50 p-2 rounded">Try: "Mike from Logistics took 2 helmets"</p>
                            <textarea className="w-full p-2 border rounded h-24" placeholder="Type here..." required value={aiPrompt} onChange={e=>setAiPrompt(e.target.value)}></textarea>
                            <button disabled={aiLoading} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 disabled:opacity-50">{aiLoading?'Processing...':'Process'}</button>
                        </form>
                    )}
                </div>
                <div className="lg:col-span-2 space-y-6">
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white p-4 rounded shadow border">
                            <p className="text-xs font-bold text-slate-500 uppercase">Total Items</p>
                            <p className="text-2xl font-bold">{inventory.reduce((a,b)=>a+b.quantity,0)}</p>
                        </div>
                        <div className="bg-white p-4 rounded shadow border">
                            <p className="text-xs font-bold text-slate-500 uppercase">Low Stock</p>
                            <p className={`text-2xl font-bold ${inventory.some(i=>i.quantity<=i.threshold)?'text-red-600':'text-green-600'}`}>{inventory.filter(i=>i.quantity<=i.threshold).length}</p>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded shadow border">
                        <h3 className="font-bold mb-4">Stock Overview</h3>
                        <SimpleChart data={inventory}/>
                    </div>
                </div>
            </div>
        );

        const InventoryView = ({ inventory, logs, setEditItem, setModalOpen, deleteItem }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [tab, setTab] = useState('ITEMS'); // ITEMS or LOGS
            
            const processedInventory = useMemo(() => {
                let data = inventory || [];
                if (searchTerm.trim()) {
                    const lower = searchTerm.toLowerCase();
                    data = data.filter(item => 
                        String(item.name || '').toLowerCase().includes(lower) || 
                        String(item.category || '').toLowerCase().includes(lower)
                    );
                }
                return [...data].sort((a, b) => {
                    const nameA = String(a.name || '').toLowerCase();
                    const nameB = String(b.name || '').toLowerCase();
                    if (nameA < nameB) return -1;
                    if (nameA > nameB) return 1;
                    return String(a.id || '').localeCompare(String(b.id || ''));
                });
            }, [inventory, searchTerm]);

            const processedLogs = useMemo(() => {
                return [...logs].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
            }, [logs]);

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div className="flex items-center gap-4">
                            <h2 className="text-xl font-bold">Inventory Management</h2>
                            <div className="flex bg-white rounded border p-1">
                                <button onClick={() => setTab('ITEMS')} className={`px-3 py-1 text-xs font-bold rounded ${tab === 'ITEMS' ? 'bg-slate-800 text-white' : 'text-slate-500'}`}>Items</button>
                                <button onClick={() => setTab('LOGS')} className={`px-3 py-1 text-xs font-bold rounded ${tab === 'LOGS' ? 'bg-slate-800 text-white' : 'text-slate-500'}`}>Logs</button>
                            </div>
                        </div>

                        {tab === 'ITEMS' ? (
                            <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                                <div className="flex gap-2">
                                     <button onClick={()=>exportToExcel(inventory, 'INVENTORY')} className="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded flex items-center justify-center gap-2 hover:bg-emerald-700 shadow-sm"><Icons.Excel/> Export List</button>
                                </div>
                                <div className="flex gap-2 w-full sm:w-auto">
                                    <div className="relative flex-1 sm:flex-none">
                                        <Icons.Search className="absolute left-3 top-2.5 text-slate-400 w-4 h-4"/>
                                        <input 
                                            type="text"
                                            autoComplete="off"
                                            autoCorrect="off"
                                            spellCheck="false"
                                            className="w-full sm:w-64 pl-9 p-2 border rounded text-sm pr-8" 
                                            placeholder="Search items..." 
                                            value={searchTerm}
                                            onChange={e => setSearchTerm(e.target.value)}
                                        />
                                        {searchTerm && (
                                            <button onClick={() => setSearchTerm('')} className="absolute right-2 top-2 text-slate-400 hover:text-slate-600 font-bold">&times;</button>
                                        )}
                                    </div>
                                    <button onClick={()=>{setEditItem(null); setModalOpen(true);}} className="bg-safety-600 text-white px-4 py-2 rounded font-bold flex gap-2 items-center whitespace-nowrap"><Icons.Plus/> Add</button>
                                </div>
                            </div>
                        ) : (
                             <button onClick={()=>exportToExcel(processedLogs, 'LOGS')} className="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded flex items-center justify-center gap-2 hover:bg-emerald-700 shadow-sm"><Icons.Excel/> Export Logs</button>
                        )}
                    </div>

                    {tab === 'ITEMS' ? (
                        <div className="bg-white rounded border overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-xs font-bold uppercase text-slate-500">
                                    <tr>
                                        <th className="p-4 w-12 text-center">No</th>
                                        <th className="p-4">Item</th>
                                        <th className="p-4">Qty</th>
                                        <th className="p-4">Status</th>
                                        <th className="p-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {processedInventory.map((i, index) => (
                                        <tr key={`${i.id}-${index}`} className="hover:bg-slate-50 group">
                                            <td className="p-4 text-center font-mono text-slate-400">{index + 1}</td>
                                            <td className="p-4"><div className="font-bold">{i.name}</div><div className="text-xs text-slate-400">{i.category}</div></td>
                                            <td className="p-4">{i.quantity} {i.unit}</td>
                                            <td className="p-4"><span className={`px-2 py-1 rounded-full text-xs font-bold ${i.quantity<=i.threshold?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}`}>{i.quantity<=i.threshold?'Low':'OK'}</span></td>
                                            <td className="p-4 text-right flex justify-end gap-2 relative z-10">
                                                <button type="button" onClick={()=>{setEditItem(i); setModalOpen(true);}} className="text-slate-400 hover:text-indigo-600 p-2 hover:bg-slate-100 rounded transition-colors" title="Edit"><Icons.Edit/></button>
                                                <button type="button" onClick={()=>deleteItem(i.id)} className="text-slate-400 hover:text-red-600 p-2 hover:bg-slate-100 rounded transition-colors" title="Delete"><Icons.Trash/></button>
                                            </td>
                                        </tr>
                                    ))}
                                    {processedInventory.length === 0 && (
                                        <tr><td colSpan="5" className="p-8 text-center text-slate-400">No items found matching "{searchTerm}"</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div className="bg-white rounded border overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-xs font-bold uppercase text-slate-500">
                                    <tr>
                                        <th className="p-4">Time</th>
                                        <th className="p-4">Action</th>
                                        <th className="p-4">Item</th>
                                        <th className="p-4">Details</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {processedLogs.map((log) => (
                                        <tr key={log.id} className="hover:bg-slate-50">
                                            <td className="p-4 whitespace-nowrap">
                                                <div className="font-bold">{new Date(log.timestamp).toLocaleDateString()}</div>
                                                <div className="text-xs text-slate-400">{new Date(log.timestamp).toLocaleTimeString()}</div>
                                            </td>
                                            <td className="p-4">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${
                                                    log.action === 'CREATE' ? 'bg-green-100 text-green-700' :
                                                    log.action === 'DELETE' ? 'bg-red-100 text-red-700' :
                                                    'bg-blue-100 text-blue-700'
                                                }`}>{log.action}</span>
                                            </td>
                                            <td className="p-4 font-medium">{log.itemName}</td>
                                            <td className="p-4 text-slate-600 font-mono text-xs">{log.changeDetails}</td>
                                        </tr>
                                    ))}
                                    {processedLogs.length === 0 && <tr><td colSpan="4" className="p-8 text-center text-slate-400">No logs available.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const SettingsView = ({ settings, setSettings, saveData, showNotif, doCloudSync, inventory, transactions, logs, onImport }) => {
            const [copied, setCopied] = useState(false);
            const [showGuide, setShowGuide] = useState(false);
            const [importText, setImportText] = useState('');
            const fileInputRef = useRef(null);
            const [importMode, setImportMode] = useState(null);

            // UPDATED GOOGLE SCRIPT CODE to be robust and prevent crashing
            // V3.0: Added Document, Gallery, and Induction Video support.
            const GOOGLE_SCRIPT_CODE = `function doPost(e){var lock=LockService.getScriptLock();lock.tryLock(10000);try{var doc=SpreadsheetApp.getActiveSpreadsheet();var d=JSON.parse(e.postData.contents);var r=function(n){return doc.getSheetByName(n)||doc.insertSheet(n)};var sv=function(k,v){if(!v)return;var s=r("Settings");var f=s.createTextFinder(k).findNext();if(f)f.offset(0,1).setValue(v);else s.appendRow([k,v])};if(d.action==="SYNC"){var s=r("Inventory");s.clear();s.appendRow(["ID","Name","Cat","Qty","Unit","Thresh","Last"]);if(d.inventory&&d.inventory.length)s.getRange(2,1,d.inventory.length,7).setValues(d.inventory.map(x=>[String(x.id),x.name,x.category,x.quantity,x.unit,x.threshold,x.lastUpdated]));s=r("Transactions");s.clear();s.appendRow(["ID","Emp","Dept","Items","Time","Method"]);if(d.transactions&&d.transactions.length)s.getRange(2,1,d.transactions.length,6).setValues(d.transactions.map(x=>[x.id,x.employeeName,x.department||"-",x.items.map(z=>z.quantity+"x "+z.itemName).join(", "),x.timestamp,x.method]));s=r("InventoryLogs");s.clear();s.appendRow(["ID","Time","Action","Item","Details"]);if(d.logs&&d.logs.length)s.getRange(2,1,d.logs.length,5).setValues(d.logs.map(x=>[x.id,x.timestamp,x.action,x.itemName,x.changeDetails]));s=r("MapData");s.clear();s.appendRow(["ID","Name","Type","Expiry","X","Y"]);if(d.markers&&d.markers.length)s.getRange(2,1,d.markers.length,6).setValues(d.markers.map(x=>[x.id,x.name,x.type,x.expiry,x.x,x.y]));s=r("Documents");s.clear();s.appendRow(["ID","Title","Cat","Date","URL"]);if(d.docs&&d.docs.length)s.getRange(2,1,d.docs.length,5).setValues(d.docs.map(x=>[x.id,x.title,x.category,x.date,x.url]));s=r("Gallery");s.clear();s.appendRow(["ID","Caption","Date","URL"]);if(d.gallery&&d.gallery.length)s.getRange(2,1,d.gallery.length,4).setValues(d.gallery.map(x=>[x.id,x.caption,x.date,x.url]));sv("Logo",d.logo);sv("MapImage",d.mapImage);sv("InductionVideo",d.inductionVideo);}return ContentService.createTextOutput(JSON.stringify({status:"success",version:"3.0"})).setMimeType(ContentService.MimeType.JSON);}catch(e){return ContentService.createTextOutput(JSON.stringify({status:"error",message:e.toString()})).setMimeType(ContentService.MimeType.JSON);}finally{lock.releaseLock();}} function doGet(e){return ContentService.createTextOutput(JSON.stringify((function(){var s=SpreadsheetApp.getActiveSpreadsheet();var g=function(n){var h=s.getSheetByName(n);return (h&&h.getLastRow()>1)?h.getRange(2,1,h.getLastRow()-1,h.getLastColumn()).getValues():[]};var st=s.getSheetByName("Settings");var val=function(k){if(!st)return "";var f=st.createTextFinder(k).findNext();return f?f.offset(0,1).getValue():""};return{status:"success",version:"3.0",inventory:g("Inventory").map(r=>({id:String(r[0]),name:r[1],category:r[2],quantity:Number(r[3]),unit:r[4],threshold:Number(r[5]),lastUpdated:r[6]})),transactions:g("Transactions").map(r=>({id:Number(r[0]),employeeName:r[1],department:r[2],items:r[3].toString().split(", ").map(x=>{var m=x.match(/^(\\d+)x (.+)$/);return{itemName:m?m[2]:x,quantity:m?Number(m[1]):0}}),timestamp:r[4],method:r[5]})),logs:g("InventoryLogs").map(r=>({id:String(r[0]),timestamp:r[1],action:r[2],itemName:r[3],changeDetails:r[4]})),markers:g("MapData").map(r=>({id:Number(r[0]),name:r[1],type:r[2],expiry:r[3],x:Number(r[4]),y:Number(r[5])})),docs:g("Documents").map(r=>({id:String(r[0]),title:r[1],category:r[2],date:r[3],url:r[4]})),gallery:g("Gallery").map(r=>({id:String(r[0]),caption:r[1],date:r[2],url:r[3]})),logo:val("Logo"),mapImage:val("MapImage"),inductionVideo:val("InductionVideo")};})())).setMimeType(ContentService.MimeType.JSON);}`;

            const parseInventory = (text) => {
                const lines = text.trim().split('\n');
                return lines.map(line => {
                    const cols = line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                    const [name, category, quantity, unit, threshold] = cols;
                    if(!name) return null;
                    return {
                        id: Date.now() + Math.random().toString(),
                        name, category: category || 'General', quantity: Number(quantity) || 0, unit: unit || 'pcs', threshold: Number(threshold) || 5, lastUpdated: new Date().toISOString()
                    };
                }).filter(i => i);
            };

            const parseHistory = (text) => {
                const lines = text.trim().split('\n');
                return lines.map(line => {
                    const cols = line.split(',').map(s => s.trim().replace(/^"|"$/g, ''));
                    const [date, time, emp, dept, item, qty, method] = cols;
                    if(!emp) return null;
                    return {
                        id: Date.now() + Math.random(),
                        employeeName: emp, department: dept || 'General',
                        items: [{itemName: item, quantity: Number(qty) || 1}],
                        timestamp: new Date(`${date}T${time}`).toISOString(),
                        method: method || 'IMPORT'
                    };
                }).filter(i => i);
            };

            const handleImportInv = () => {
                const newItems = parseInventory(importText);
                if(newItems.length) {
                    onImport(newItems, null);
                    setImportText('');
                    showNotif(`Imported ${newItems.length} items`);
                }
            };

            const handleImportHist = () => {
                const newTx = parseHistory(importText);
                if(newTx.length) {
                    onImport(null, newTx);
                    setImportText('');
                    showNotif(`Imported ${newTx.length} records`);
                }
            };

            const triggerFileUpload = (mode) => {
                setImportMode(mode);
                if(fileInputRef.current) {
                    fileInputRef.current.value = ''; // reset
                    fileInputRef.current.click();
                }
            };

            const onFileChange = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const text = evt.target.result;
                    if(importMode === 'INV') {
                         const data = parseInventory(text);
                         onImport(data, null);
                         showNotif(`Uploaded ${data.length} items`);
                    } else {
                         const data = parseHistory(text);
                         onImport(null, data);
                         showNotif(`Uploaded ${data.length} logs`);
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="max-w-2xl mx-auto space-y-6 animate-fade-in pb-12">
                     <div className="bg-white p-6 rounded border">
                        <h3 className="font-bold text-lg mb-4">Data Import (CSV)</h3>
                        <div className="text-xs text-slate-500 mb-2">Paste data OR upload .csv file. No headers needed.</div>
                        
                        <textarea 
                            className="w-full p-2 border rounded h-32 text-xs font-mono mb-4" 
                            placeholder="INVENTORY: Name, Category, Qty, Unit, MinLimit&#10;HISTORY: YYYY-MM-DD, HH:MM, Name, Dept, Item, Qty, Method"
                            value={importText}
                            onChange={e => setImportText(e.target.value)}
                        />
                        
                        <div className="grid grid-cols-2 gap-4">
                            <div className="flex gap-2">
                                <button onClick={handleImportInv} className="bg-slate-200 text-slate-800 px-3 py-2 rounded text-sm font-bold flex-1 hover:bg-slate-300">Paste Inv</button>
                                <button onClick={()=>triggerFileUpload('INV')} className="bg-slate-200 text-slate-800 px-3 py-2 rounded text-sm font-bold hover:bg-slate-300 flex items-center justify-center" title="Upload CSV"><Icons.Upload/></button>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleImportHist} className="bg-slate-200 text-slate-800 px-3 py-2 rounded text-sm font-bold flex-1 hover:bg-slate-300">Paste Hist</button>
                                <button onClick={()=>triggerFileUpload('HIST')} className="bg-slate-200 text-slate-800 px-3 py-2 rounded text-sm font-bold hover:bg-slate-300 flex items-center justify-center" title="Upload CSV"><Icons.Upload/></button>
                            </div>
                        </div>
                        <input type="file" ref={fileInputRef} className="hidden" accept=".csv" onChange={onFileChange} />
                    </div>

                    <div className="bg-white p-6 rounded border">
                         <h3 className="font-bold text-lg mb-4">Export Data (Excel)</h3>
                         <div className="flex flex-col gap-3">
                            <button onClick={()=>exportToExcel(inventory, 'INVENTORY')} className="flex items-center justify-center gap-2 border p-3 rounded hover:bg-emerald-50 text-sm font-bold text-emerald-700">
                                <Icons.Excel/> Inventory List (.xls)
                            </button>
                            <button onClick={()=>exportToExcel(transactions, 'HISTORY')} className="flex items-center justify-center gap-2 border p-3 rounded hover:bg-emerald-50 text-sm font-bold text-emerald-700">
                                <Icons.Excel/> Transaction History (.xls)
                            </button>
                            <button onClick={()=>exportToExcel(logs, 'LOGS')} className="flex items-center justify-center gap-2 border p-3 rounded hover:bg-emerald-50 text-sm font-bold text-emerald-700">
                                <Icons.Excel/> Inventory Logs (.xls)
                            </button>
                         </div>
                    </div>

                    <div className="bg-white p-6 rounded border">
                         <h3 className="font-bold text-lg mb-2">Google Sheets Sync (Required for Phone Access)</h3>
                         <button onClick={()=>setShowGuide(!showGuide)} className="text-indigo-600 underline text-sm font-bold mb-4">
                            {showGuide ? "Hide Guide" : "Show Setup Guide"}
                         </button>
                         {showGuide && (
                             <div className="bg-indigo-50 border border-indigo-100 p-4 rounded text-sm text-slate-700 space-y-2 mb-6">
                                <p><strong>⚠️ Critical Update 3.0:</strong> Added Documents, Gallery, and Induction Video support.</p>
                                <p>1. Copy the code below.</p>
                                <p>2. Go to Google Sheets &gt; Extensions &gt; Apps Script.</p>
                                <p>3. Paste code &gt; <strong>Deploy</strong> &gt; <strong>New Deployment</strong> (Select "New version").</p>
                                <p>4. Ensure access is set to <strong>"Anyone"</strong>.</p>
                             </div>
                         )}
                         <div className="bg-slate-900 text-slate-300 p-3 rounded font-mono text-xs h-32 overflow-y-auto mb-2 relative">
                            {GOOGLE_SCRIPT_CODE}
                            <button onClick={()=>{navigator.clipboard.writeText(GOOGLE_SCRIPT_CODE); setCopied(true); setTimeout(()=>setCopied(false),2000);}} className="absolute top-2 right-2 bg-white text-slate-900 px-2 py-1 rounded font-bold text-xs hover:bg-slate-200">{copied ? "Copied!" : "Copy Code"}</button>
                         </div>
                        <label className="block text-xs font-bold text-slate-500 mb-1">Web App URL</label>
                        <input className="w-full p-2 border rounded mb-4 font-mono text-sm" placeholder="https://script.google.com/..." value={settings.sheetUrl} onChange={e=>setSettings({...settings, sheetUrl:e.target.value})}/>
                        <label className="block text-xs font-bold text-slate-500 mb-1">Induction Video URL (YouTube)</label>
                        <input className="w-full p-2 border rounded mb-4 text-sm" placeholder="https://youtube.com/watch?v=..." value={settings.inductionVideo} onChange={e=>setSettings({...settings, inductionVideo:e.target.value})}/>
                        <div className="flex gap-2">
                            <button onClick={()=>{saveData(STORAGE_KEYS.SETTINGS, settings); showNotif('Settings Saved');}} className="bg-safety-600 text-white px-4 py-2 rounded font-bold flex-1">Save Settings</button>
                            <button onClick={()=>doCloudSync(false, true)} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold flex-1 flex items-center justify-center gap-2"><Icons.CloudUp/> Force Save to Cloud</button>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded border">
                        <h3 className="font-bold mb-4">Gemini AI Key</h3>
                        <input type="password" className="w-full p-2 border rounded" placeholder="Paste API Key..." value={settings.apiKey} onChange={e=>setSettings({...settings, apiKey:e.target.value})}/>
                        <button onClick={()=>{saveData(STORAGE_KEYS.SETTINGS, settings); showNotif('Key Saved');}} className="mt-2 bg-slate-200 text-slate-700 px-4 py-1 rounded text-sm font-bold">Save Key</button>
                    </div>
                </div>
            );
        };

        // --- NEW MODULE COMPONENTS ---

        const DocumentView = ({ docs, addDoc, deleteDoc }) => {
            const [uploadMode, setUploadMode] = useState(false);
            const grouped = useMemo(() => {
                const g = {};
                docs.forEach(d => { const m = d.date.substring(0, 7); if(!g[m]) g[m] = []; g[m].push(d); });
                return Object.entries(g).sort((a,b) => b[0].localeCompare(a[0]));
            }, [docs]);

            const handleFile = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const file = e.target.file.files[0];
                const processDoc = (url) => {
                    addDoc({ id: Date.now().toString(), title: fd.get('title'), category: fd.get('type'), date: fd.get('date'), url: url });
                    setUploadMode(false);
                };
                if(file) { const r = new FileReader(); r.onload = (evt) => processDoc(evt.target.result); r.readAsDataURL(file); } 
                else { processDoc(fd.get('url')); }
            };

            return (
                <div className="animate-fade-in space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-bold">Documents</h2>
                        <button onClick={()=>setUploadMode(true)} className="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm flex gap-2 items-center"><Icons.Plus/> Add Document</button>
                    </div>
                    {uploadMode && (
                        <div className="bg-white p-6 rounded border shadow-lg">
                            <h3 className="font-bold mb-4">Add Document</h3>
                            <form onSubmit={handleFile} className="space-y-4">
                                <div className="grid grid-cols-2 gap-4"><input name="title" required placeholder="Title" className="p-2 border rounded"/><input name="date" type="date" required className="p-2 border rounded" defaultValue={new Date().toISOString().split('T')[0]}/></div>
                                <select name="type" className="p-2 border rounded w-full"><option>Report</option><option>Policy</option><option>Audit</option><option>Training</option></select>
                                <div className="p-4 bg-slate-50 border rounded"><input name="url" placeholder="External Link (Google Drive...)" className="p-2 border rounded w-full text-sm mb-2"/><div className="text-center text-xs text-slate-400">- OR -</div><input type="file" name="file" accept=".pdf,.doc,.docx" className="w-full text-sm mt-2"/></div>
                                <div className="flex gap-2"><button type="button" onClick={()=>setUploadMode(false)} className="flex-1 bg-slate-200 py-2 rounded font-bold">Cancel</button><button className="flex-1 bg-blue-600 text-white py-2 rounded font-bold">Save</button></div>
                            </form>
                        </div>
                    )}
                    <div className="space-y-8">{grouped.map(([month, items]) => (
                        <div key={month} className="relative pl-8 border-l-2 border-slate-200">
                            <div className="absolute -left-2 top-0 w-4 h-4 rounded-full bg-blue-500 ring-4 ring-white"></div>
                            <h3 className="font-bold text-lg mb-4 text-slate-700">{new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">{items.map(doc => (
                                <div key={doc.id} className="bg-white p-4 rounded border hover:shadow-md group relative">
                                    <button onClick={()=>deleteDoc(doc.id)} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icons.Trash/></button>
                                    <div className="flex items-start gap-3"><div className="p-2 bg-blue-50 text-blue-600 rounded"><Icons.File/></div><div className="flex-1 min-w-0"><div className="font-bold truncate">{doc.title}</div><div className="text-xs text-slate-500">{doc.category} • {new Date(doc.date).toLocaleDateString()}</div><a href={doc.url} target="_blank" className="mt-2 inline-block text-xs font-bold text-blue-600 hover:underline">Download &rarr;</a></div></div>
                                </div>
                            ))}</div>
                        </div>
                    ))}</div>
                </div>
            );
        };

        const GalleryView = ({ photos, addPhoto, deletePhoto }) => {
            const [uploadMode, setUploadMode] = useState(false);
            const handlePhoto = (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const file = e.target.file.files[0];
                const process = (url) => { addPhoto({ id: Date.now().toString(), caption: fd.get('caption'), date: fd.get('date'), url: url }); setUploadMode(false); };
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const img = new Image();
                        img.onload = () => { const c = document.createElement('canvas'); const ctx = c.getContext('2d'); let w=img.width,h=img.height; if(w>800){h*=800/w;w=800;} c.width=w;c.height=h; ctx.drawImage(img,0,0,w,h); process(c.toDataURL('image/jpeg',0.6)); };
                        img.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                } else { process(fd.get('url')); }
            };
            const grouped = useMemo(() => { const g={}; photos.forEach(p=>{const m=p.date.substring(0,7); if(!g[m])g[m]=[]; g[m].push(p)}); return Object.entries(g).sort((a,b)=>b[0].localeCompare(a[0])); }, [photos]);

            return (
                <div className="animate-fade-in space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-bold">Gallery</h2>
                        <button onClick={()=>setUploadMode(true)} className="bg-purple-600 text-white px-4 py-2 rounded font-bold text-sm flex gap-2 items-center"><Icons.Plus/> Add Photo</button>
                    </div>
                    {uploadMode && (
                        <div className="bg-white p-6 rounded border shadow-lg max-w-lg mx-auto">
                            <h3 className="font-bold mb-4">Add Photo</h3>
                            <form onSubmit={handlePhoto} className="space-y-4">
                                <input name="caption" required placeholder="Caption" className="p-2 border rounded w-full"/>
                                <input name="date" type="date" required className="p-2 border rounded w-full" defaultValue={new Date().toISOString().split('T')[0]}/>
                                <div className="p-4 bg-slate-50 border rounded"><input name="url" placeholder="Image Link" className="p-2 border rounded w-full text-sm mb-2"/><div className="text-center text-xs text-slate-300">- OR -</div><input type="file" name="file" accept="image/*" className="w-full text-sm mt-2"/></div>
                                <div className="flex gap-2"><button type="button" onClick={()=>setUploadMode(false)} className="flex-1 bg-slate-200 py-2 rounded font-bold">Cancel</button><button className="flex-1 bg-purple-600 text-white py-2 rounded font-bold">Save</button></div>
                            </form>
                        </div>
                    )}
                    <div className="space-y-8">{grouped.map(([month, items]) => (
                        <div key={month}>
                            <h3 className="font-bold text-lg mb-4 text-slate-700 border-b pb-2">{new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">{items.map(p => (
                                <div key={p.id} className="group relative bg-white rounded overflow-hidden shadow border aspect-square">
                                    <img src={p.url} className="w-full h-full object-cover transition-transform group-hover:scale-110" />
                                    <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-2">
                                        <p className="text-white font-bold text-sm truncate">{p.caption}</p><p className="text-slate-300 text-xs">{new Date(p.date).toLocaleDateString()}</p>
                                        <button onClick={()=>deletePhoto(p.id)} className="absolute top-2 right-2 bg-red-600 text-white p-1 rounded hover:bg-red-700"><Icons.Trash/></button>
                                    </div>
                                </div>
                            ))}</div>
                        </div>
                    ))}</div>
                </div>
            );
        };

        const InductionView = ({ videoUrl }) => {
            const getEmbedUrl = (url) => { if(!url) return null; if(url.includes('youtube')||url.includes('youtu.be')) { const id=url.split('v=')[1]||url.split('/').pop(); return `https://www.youtube.com/embed/${id.split('&')[0]}`; } return url; };
            const src = getEmbedUrl(videoUrl);
            return (
                <div className="animate-fade-in flex flex-col items-center justify-center min-h-[500px] text-center">
                    <div className="w-full max-w-4xl bg-black rounded-xl overflow-hidden shadow-2xl relative aspect-video video-container">
                        {src ? <iframe src={src} frameBorder="0" allowFullScreen></iframe> : <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-500"><Icons.Video className="w-16 h-16 mb-4 opacity-50"/><p>No video URL configured.</p></div>}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [activeSection, setActiveSection] = useState('PPE'); // PPE, DOCS, INDUCTION, GALLERY, SETTINGS
            const [ppeView, setPpeView] = useState('DASHBOARD'); // Sub-view for PPE
            const [ppeExpanded, setPpeExpanded] = useState(true); // Sidebar Accordion State
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false); // NEW STATE
            
            // Global Data
            const [inventory, setInventory] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [inventoryLogs, setInventoryLogs] = useState([]);
            const [docs, setDocs] = useState([]);
            const [gallery, setGallery] = useState([]);
            
            // Settings & State
            const [settings, setSettings] = useState({ apiKey: '', sheetUrl: '', inductionVideo: '' });
            const [notify, setNotify] = useState(null);
            const [logo, setLogo] = useState(null);
            
            // Map State
            const [mapImage, setMapImage] = useState(null);
            const [markers, setMarkers] = useState([]);

            // Modal States
            const [modalOpen, setModalOpen] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [txModalOpen, setTxModalOpen] = useState(false);
            const [editTx, setEditTx] = useState(null);
            
            const [qrOpen, setQrOpen] = useState(false);
            const [coTab, setCoTab] = useState('manual');
            const [coData, setCoData] = useState({ name: '', dept: '', item: '', qty: '1' });
            
            const [aiPrompt, setAiPrompt] = useState('');
            const [aiLoading, setAiLoading] = useState(false);

            // History Search
            const [txSearch, setTxSearch] = useState('');

            const showNotif = (msg) => { setNotify(msg); setTimeout(() => setNotify(null), 3000); };

            const doCloudSync = async (silent=false, forcePush=false) => {
                if(!settings.sheetUrl) { if(!silent) showNotif('No Sheet URL'); return; }
                if(!silent) showNotif(forcePush ? 'Saving to Cloud...' : 'Syncing...');
                
                const dataPkg = { inventory, transactions, logs: inventoryLogs, docs, gallery, markers, mapImage, logo, inductionVideo: settings.inductionVideo };

                if (forcePush) {
                    await syncSheets(settings.sheetUrl, dataPkg);
                    if(!silent) showNotif('Saved to Cloud!');
                    return;
                }

                const cloud = await fetchSheets(settings.sheetUrl);
                if(cloud) {
                    if (cloud.inventory) {
                        const uniqueInv = deduplicateInventory(cloud.inventory.map(i => ({...i, id: String(i.id).trim()})));
                        setInventory(uniqueInv);
                        setTransactions(cloud.transactions || []);
                        setInventoryLogs(cloud.logs || []);
                        setDocs(cloud.docs || []);
                        setGallery(cloud.gallery || []);
                        
                        if(cloud.mapImage && cloud.mapImage.trim() !== '') setMapImage(cloud.mapImage);
                        if(cloud.markers) setMarkers(cloud.markers);
                        if(cloud.logo && isValidLogo(cloud.logo)) setLogo(cloud.logo);
                        if(cloud.inductionVideo) setSettings(s => ({...s, inductionVideo: cloud.inductionVideo}));
                        
                        // Save Local
                        saveData(STORAGE_KEYS.INVENTORY, uniqueInv);
                        saveData(STORAGE_KEYS.TRANSACTIONS, cloud.transactions || []);
                        saveData(STORAGE_KEYS.INV_LOGS, cloud.logs || []);
                        saveData(STORAGE_KEYS.DOCS, cloud.docs || []);
                        saveData(STORAGE_KEYS.GALLERY, cloud.gallery || []);
                        if(cloud.mapImage) saveData(STORAGE_KEYS.MAP_IMG, cloud.mapImage);
                        if(cloud.markers) saveData(STORAGE_KEYS.MAP_MARKERS, cloud.markers);
                        if(cloud.logo) saveData(STORAGE_KEYS.LOGO, cloud.logo);

                        if(!silent) showNotif('Sync Complete!');
                    }
                } else {
                    if(!silent) showNotif('Sync Failed');
                }
            };

            const updateAll = (updates) => {
                if(updates.inventory) { setInventory(updates.inventory); saveData(STORAGE_KEYS.INVENTORY, updates.inventory); }
                if(updates.transactions) { setTransactions(updates.transactions); saveData(STORAGE_KEYS.TRANSACTIONS, updates.transactions); }
                if(updates.logs) { setInventoryLogs(updates.logs); saveData(STORAGE_KEYS.INV_LOGS, updates.logs); }
                if(updates.docs) { setDocs(updates.docs); saveData(STORAGE_KEYS.DOCS, updates.docs); }
                if(updates.gallery) { setGallery(updates.gallery); saveData(STORAGE_KEYS.GALLERY, updates.gallery); }
                if(updates.markers) { setMarkers(updates.markers); saveData(STORAGE_KEYS.MAP_MARKERS, updates.markers); }
                if(updates.mapImage) { setMapImage(updates.mapImage); saveData(STORAGE_KEYS.MAP_IMG, updates.mapImage); }
                
                syncSheets(settings.sheetUrl, { 
                    inventory: updates.inventory || inventory, 
                    transactions: updates.transactions || transactions, 
                    logs: updates.logs || inventoryLogs, 
                    docs: updates.docs || docs, 
                    gallery: updates.gallery || gallery, 
                    markers: updates.markers || markers, 
                    mapImage: updates.mapImage || mapImage, 
                    logo, inductionVideo: settings.inductionVideo 
                });
            };

            const addLog = (action, itemName, details) => {
                const newLog = { id: Date.now().toString() + Math.random().toString().slice(2, 5), timestamp: new Date().toISOString(), action, itemName, changeDetails: details };
                const newLogs = [newLog, ...inventoryLogs];
                return newLogs;
            };

            useEffect(() => {
                let s = safeParse(STORAGE_KEYS.SETTINGS, { apiKey: '', sheetUrl: '', inductionVideo: '' });
                const lastKnownDefault = localStorage.getItem('ppe_app_version_ref');
                if (DEFAULT_WEB_APP_URL && DEFAULT_WEB_APP_URL !== lastKnownDefault) {
                    s.sheetUrl = DEFAULT_WEB_APP_URL;
                    saveData(STORAGE_KEYS.SETTINGS, s);
                    localStorage.setItem('ppe_app_version_ref', DEFAULT_WEB_APP_URL);
                } else if (!s.sheetUrl && DEFAULT_WEB_APP_URL) {
                    s.sheetUrl = DEFAULT_WEB_APP_URL;
                    saveData(STORAGE_KEYS.SETTINGS, s);
                    localStorage.setItem('ppe_app_version_ref', DEFAULT_WEB_APP_URL);
                }
                setSettings(s);
                
                const savedLogo = localStorage.getItem(STORAGE_KEYS.LOGO);
                if (isValidLogo(savedLogo)) setLogo(savedLogo);

                const savedMap = localStorage.getItem(STORAGE_KEYS.MAP_IMG);
                if (savedMap && savedMap.length > 50) setMapImage(savedMap);
                else setMapImage(DEFAULT_MAP_URL);

                setMarkers(safeParse(STORAGE_KEYS.MAP_MARKERS, []));
                setInventory(deduplicateInventory(safeParse(STORAGE_KEYS.INVENTORY, [])));
                setTransactions(safeParse(STORAGE_KEYS.TRANSACTIONS, []));
                setInventoryLogs(safeParse(STORAGE_KEYS.INV_LOGS, []));
                setDocs(safeParse(STORAGE_KEYS.DOCS, []));
                setGallery(safeParse(STORAGE_KEYS.GALLERY, []));
                
                if(s.sheetUrl) fetchSheets(s.sheetUrl).then(d => {
                    if(d && d.inventory) {
                         const uniqueInv = deduplicateInventory(d.inventory.map(i => ({...i, id: String(i.id).trim()})));
                         setInventory(uniqueInv);
                         setTransactions(d.transactions||[]);
                         setInventoryLogs(d.logs||[]);
                         setDocs(d.docs||[]);
                         setGallery(d.gallery||[]);
                         if(d.mapImage) setMapImage(d.mapImage);
                         if(d.markers) setMarkers(d.markers);
                         if(d.logo && isValidLogo(d.logo)) setLogo(d.logo);
                         if(d.inductionVideo) setSettings(curr => ({...curr, inductionVideo: d.inductionVideo}));
                    }
                });
            }, []);

            // PPE ACTIONS
            const handleCheckout = (name, dept, itemId, qty, method) => {
                const item = inventory.find(i => i.id === itemId);
                if (!item) return;
                const newInv = inventory.map(i => i.id === itemId ? { ...i, quantity: Math.max(0, i.quantity - qty), lastUpdated: new Date().toISOString() } : i);
                const newTx = [{ id: Date.now(), employeeName: name, department: dept, items: [{ itemName: item.name, quantity: qty }], timestamp: new Date().toISOString(), method }, ...transactions];
                updateAll({ inventory: newInv, transactions: newTx });
                showNotif('Checkout Success');
                setCoData({ ...coData, item: '', qty: '1' });
            };

            const handleAiCheckout = async (e) => {
                e.preventDefault();
                if(!settings.apiKey) return alert("Please set API Key in Settings first.");
                setAiLoading(true);
                try {
                    const invList = inventory.map(i => `- ${i.name}`).join("\n");
                    const sys = `Extract JSON: { "employeeName": "string", "department": "string (optional)", "items": [{"itemNameTarget": "exact string from list", "quantity": number}] }. Inventory: \n${invList}`;
                    const res = await callGemini(settings.apiKey, aiPrompt, sys);
                    const data = JSON.parse(res.candidates[0].content.parts[0].text);
                    if(data.items) {
                        data.items.forEach(req => {
                            const found = inventory.find(i => i.name === req.itemNameTarget);
                            if (found) handleCheckout(data.employeeName || 'Unknown', data.department || 'General', found.id, req.quantity, 'AI');
                        });
                        setAiPrompt('');
                    }
                } catch (e) { alert("AI Error: " + e.message); }
                setAiLoading(false);
            };

            const saveItem = (item) => {
                const safeId = String(item.id).trim();
                const existingIdx = inventory.findIndex(i => String(i.id).trim() === safeId);
                let newInv, newLogs;
                if (existingIdx >= 0) {
                    const old = inventory[existingIdx];
                    let changes = [];
                    if(old.quantity !== item.quantity) changes.push(`Qty: ${old.quantity} -> ${item.quantity}`);
                    if(changes.length === 0) changes.push("Updated details");
                    newLogs = addLog('UPDATE', item.name, changes.join(', '));
                    newInv = [...inventory]; newInv[existingIdx] = { ...item, id: safeId }; 
                } else {
                    newLogs = addLog('CREATE', item.name, `Initial Qty: ${item.quantity}`);
                    newInv = [...inventory, { ...item, id: safeId }];
                }
                updateAll({ inventory: newInv, logs: newLogs });
                setModalOpen(false); setEditItem(null); showNotif('Item Saved');
            };

            const deleteItem = (id) => {
                if(!confirm("Delete?")) return;
                const safeId = String(id).trim();
                const item = inventory.find(i => String(i.id).trim() === safeId);
                if(item) {
                    const newLogs = addLog('DELETE', item.name, 'Item removed from database');
                    updateAll({ inventory: inventory.filter(i => String(i.id).trim() !== safeId), logs: newLogs });
                    showNotif('Item Deleted');
                }
            };
            
            const saveTx = (tx) => {
                const newTx = transactions.map(t => t.id === tx.id ? tx : t);
                updateAll({ transactions: newTx });
                setTxModalOpen(false); showNotif('Log Updated');
            };

            const deleteTx = (id) => {
                if(!confirm("Delete log?")) return;
                updateAll({ transactions: transactions.filter(t => t.id !== id) });
                showNotif('Log Deleted');
            };

            const handleImport = (importedInv, importedHist) => {
                let updates = {};
                if (importedInv) {
                    const uniqueInv = deduplicateInventory([...inventory, ...importedInv]);
                    const newLogs = addLog('UPDATE', 'Bulk Import', `Imported ${importedInv.length} items`);
                    updates.inventory = uniqueInv;
                    updates.logs = newLogs;
                }
                if (importedHist) {
                    updates.transactions = [...transactions, ...importedHist];
                }
                updateAll(updates);
            };

            const handleLogoUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        if(isValidLogo(reader.result)) {
                            setLogo(reader.result);
                            localStorage.setItem(STORAGE_KEYS.LOGO, reader.result);
                            syncSheets(settings.sheetUrl, { inventory, transactions, logs: inventoryLogs, docs, gallery, logo: reader.result, markers, mapImage, inductionVideo: settings.inductionVideo });
                            showNotif('Logo Updated');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };

            const filteredTransactions = transactions.filter(t => 
                t.employeeName.toLowerCase().includes(txSearch.toLowerCase()) || 
                (t.department && t.department.toLowerCase().includes(txSearch.toLowerCase())) ||
                t.items.some(i => i.itemName.toLowerCase().includes(txSearch.toLowerCase()))
            );

            // New Section Actions
            const addDoc = (doc) => { updateAll({ docs: [doc, ...docs] }); showNotif('Document Added'); };
            const deleteDoc = (id) => { if(confirm('Delete?')) updateAll({ docs: docs.filter(d=>d.id!==id) }); };
            const addPhoto = (photo) => { updateAll({ gallery: [photo, ...gallery] }); showNotif('Photo Added'); };
            const deletePhoto = (id) => { if(confirm('Delete?')) updateAll({ gallery: gallery.filter(g=>g.id!==id) }); };
            
            // NAVIGATION HANDLERS
            const togglePPE = () => {
                setPpeExpanded(!ppeExpanded);
                if(!ppeExpanded) setActiveSection('PPE');
            };
            
            const handlePpeNav = (view) => {
                setActiveSection('PPE');
                setPpeView(view);
                setMobileMenuOpen(false); // Close menu on selection
            };
            
            const handleSectionNav = (id) => {
                setActiveSection(id);
                setMobileMenuOpen(false); // Close menu on selection
            }

            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-slate-50 text-slate-800">
                    <aside className={`bg-slate-900 text-white w-full md:w-20 lg:w-64 flex flex-col shrink-0 z-50 md:h-screen sticky top-0 transition-all duration-300 ${mobileMenuOpen ? 'h-auto shadow-2xl' : 'h-16 md:h-screen overflow-hidden md:overflow-y-auto'}`}>
                        <div className="flex items-center justify-between p-4 md:flex-col md:items-center lg:items-start md:gap-3 md:mb-8 md:p-2 md:py-4 shrink-0">
                            <div className="flex items-center gap-3 md:flex-col md:items-center lg:items-start">
                                <label className="relative cursor-pointer group logo-hover shrink-0">
                                    <img 
                                        src={logo || `https://ui-avatars.com/api/?name=GC&background=f97316&color=fff&size=128&bold=true`} 
                                        className="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white object-contain border-2 border-safety-500" 
                                    />
                                    <div className="logo-edit absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 transition-opacity">
                                        <Icons.Camera className="text-white w-3 h-3 md:w-4 md:h-4" />
                                    </div>
                                    <input type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} />
                                </label>
                                <div className="block md:hidden lg:block">
                                    <div className="font-bold text-sm md:text-base text-safety-500 leading-tight">Gold Coin Bekasi</div>
                                    <div className="text-[10px] text-slate-500 uppercase tracking-wider">HSE Portal</div>
                                </div>
                            </div>
                            
                            {/* Mobile Toggle */}
                            <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="md:hidden text-slate-400 hover:text-white p-1">
                                {mobileMenuOpen ? <Icons.X /> : <Icons.Menu />}
                            </button>
                        </div>
                        
                        <div className={`${mobileMenuOpen ? 'flex' : 'hidden'} md:flex flex-col flex-1 px-2 pb-4 md:px-0 md:pb-0`}>
                            <nav className="flex-1 space-y-2">
                                {/* PPE ACCORDION */}
                                <div>
                                    <button 
                                        onClick={togglePPE}
                                        className={`w-full flex items-center justify-between px-2 lg:px-4 py-3 rounded text-sm font-medium transition-colors ${activeSection === 'PPE' ? 'bg-safety-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}
                                    >
                                        <div className="flex items-center gap-3">
                                            <Icons.HardHat />
                                            <span className="md:hidden lg:inline">PPE Manager</span>
                                        </div>
                                        <div className="md:hidden lg:block">
                                            {ppeExpanded ? <Icons.ChevronDown /> : <Icons.ChevronRight />}
                                        </div>
                                    </button>
                                    
                                    <div className={`sub-menu ${ppeExpanded ? 'open' : ''} space-y-1 mt-1 lg:pl-4`}>
                                        {[
                                            {id:'DASHBOARD', icon: Icons.Dashboard, label:'Dashboard'},
                                            {id:'INVENTORY', icon: Icons.List, label:'Inventory'},
                                            {id:'HISTORY', icon: Icons.History, label:'History'},
                                            {id:'MAP', icon: Icons.Map, label:'Facility Map'},
                                            {id:'TRACKER', icon: Icons.User, label:'Tracker'}
                                        ].map(sub => (
                                            <button 
                                                key={sub.id} 
                                                onClick={() => handlePpeNav(sub.id)}
                                                className={`w-full flex items-center gap-3 px-2 lg:px-4 py-2 rounded text-xs lg:text-sm font-medium transition-colors ${activeSection === 'PPE' && ppeView === sub.id ? 'text-safety-500 bg-slate-800' : 'text-slate-500 hover:text-slate-300'}`}
                                            >
                                                <sub.icon />
                                                <span className="md:hidden lg:inline">{sub.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* OTHER SECTIONS */}
                                {[
                                    {id:'DOCS', icon: Icons.File, label:'Documents'},
                                    {id:'INDUCTION', icon: Icons.Play, label:'Induction'},
                                    {id:'GALLERY', icon: Icons.Image, label:'Gallery'},
                                    {id:'SETTINGS', icon: Icons.Settings, label:'Settings'}
                                ].map(item => (
                                    <button 
                                        key={item.id} 
                                        onClick={() => handleSectionNav(item.id)} 
                                        className={`w-full flex items-center gap-3 px-2 lg:px-4 py-3 rounded text-sm font-medium transition-colors ${activeSection === item.id ? 'bg-safety-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'}`}
                                    >
                                        <item.icon /> 
                                        <span className="md:hidden lg:inline">{item.label}</span>
                                    </button>
                                ))}
                            </nav>
                            
                            <div className="pt-4 border-t border-slate-800 space-y-2">
                                <button onClick={()=>setQrOpen(true)} className="flex gap-2 text-xs text-slate-400 w-full px-4 py-2 hover:bg-slate-800 rounded"><Icons.Qr/> Mobile Access</button>
                                <button onClick={()=>{doCloudSync();}} className="flex gap-2 text-xs text-green-400 w-full px-4 py-2 hover:bg-slate-800 rounded"><Icons.Refresh/> Quick Sync</button>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 p-4 md:p-8 md:overflow-y-auto md:h-screen">
                        <div className="max-w-6xl mx-auto pb-12">
                            
                            {/* SECTION: PPE MANAGEMENT */}
                            {activeSection === 'PPE' && (
                                <div className="animate-fade-in space-y-6">
                                    <div className="flex items-center justify-between">
                                        <h2 className="text-2xl font-bold text-slate-800">
                                            {ppeView === 'DASHBOARD' ? 'PPE Dashboard' : 
                                             ppeView === 'INVENTORY' ? 'Inventory Manager' :
                                             ppeView === 'HISTORY' ? 'Transaction Logs' :
                                             ppeView === 'MAP' ? 'Facility Map' : 'Personal Tracker'}
                                        </h2>
                                    </div>
                                    
                                    {ppeView === 'DASHBOARD' && 
                                        <DashboardView 
                                            inventory={inventory} 
                                            coTab={coTab} setCoTab={setCoTab}
                                            coData={coData} setCoData={setCoData}
                                            aiPrompt={aiPrompt} setAiPrompt={setAiPrompt}
                                            aiLoading={aiLoading}
                                            handleCheckout={handleCheckout}
                                            handleAiCheckout={handleAiCheckout}
                                        />
                                    }
                                    {ppeView === 'INVENTORY' && 
                                        <InventoryView 
                                            inventory={inventory}
                                            logs={inventoryLogs}
                                            setEditItem={setEditItem}
                                            setModalOpen={setModalOpen}
                                            deleteItem={deleteItem}
                                        />
                                    }
                                    {ppeView === 'MAP' && (
                                        <MapView 
                                            mapImage={mapImage}
                                            markers={markers}
                                            updateMap={updateAll}
                                        />
                                    )}
                                    {ppeView === 'HISTORY' && (
                                        <div className="space-y-4">
                                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                                <div className="flex gap-2 w-full sm:w-auto">
                                                    <input 
                                                        type="text"
                                                        className="p-2 border rounded text-sm w-full sm:w-64" 
                                                        placeholder="Search logs..." 
                                                        value={txSearch}
                                                        onChange={e => setTxSearch(e.target.value)}
                                                    />
                                                    <button onClick={()=>exportToExcel(transactions, 'HISTORY')} className="bg-emerald-600 text-white px-3 py-2 rounded text-xs font-bold flex gap-1 items-center hover:bg-emerald-700 whitespace-nowrap"><Icons.Excel/> XLS</button>
                                                </div>
                                            </div>
                                            {filteredTransactions.map(t=>(
                                                <div key={t.id} className="bg-white p-4 rounded border flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 hover:shadow-sm group relative">
                                                    <div className="flex-1">
                                                        <div className="font-bold flex items-center gap-2">
                                                            {t.employeeName} 
                                                            <span className="text-xs font-normal text-slate-500 bg-slate-100 px-2 py-0.5 rounded">{t.department || '-'}</span>
                                                        </div>
                                                        <div className="text-xs text-slate-400 mt-1 flex gap-2">
                                                            <span>{new Date(t.timestamp).toLocaleString()}</span>
                                                            <span>&bull;</span>
                                                            <span>{t.method}</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-end">
                                                        <div className="text-right">
                                                            {t.items.map((i,k)=>(
                                                                <div key={k} className="text-sm">
                                                                    <span className="font-mono font-bold">{i.quantity}x</span> <span className="font-medium">{i.itemName}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                        
                                                        <div className="flex gap-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                                            <button 
                                                                onClick={() => { setEditTx(t); setTxModalOpen(true); }} 
                                                                className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded transition-colors" 
                                                                title="Edit Record"
                                                            >
                                                                <Icons.Edit />
                                                            </button>
                                                            <button 
                                                                onClick={() => deleteTx(t.id)} 
                                                                className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" 
                                                                title="Delete Record"
                                                            >
                                                                <Icons.Trash />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            {filteredTransactions.length===0 && <div className="text-center text-slate-400 p-8 border rounded border-dashed">No records found.</div>}
                                        </div>
                                    )}
                                    {ppeView === 'TRACKER' && <PersonalTrackerView transactions={transactions} />}
                                </div>
                            )}

                            {/* SECTION: DOCUMENTS */}
                            {activeSection === 'DOCS' && (
                                <div className="animate-fade-in">
                                    <h2 className="text-2xl font-bold text-slate-800 mb-6">Documents</h2>
                                    <DocumentView docs={docs} addDoc={addDoc} deleteDoc={deleteDoc} />
                                </div>
                            )}

                            {/* SECTION: INDUCTION */}
                            {activeSection === 'INDUCTION' && (
                                <div className="animate-fade-in">
                                    <h2 className="text-2xl font-bold text-slate-800 mb-6">Safety Induction</h2>
                                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                                        <InductionView videoUrl={settings.inductionVideo} />
                                    </div>
                                </div>
                            )}

                            {/* SECTION: GALLERY */}
                            {activeSection === 'GALLERY' && (
                                <div className="animate-fade-in">
                                    <h2 className="text-2xl font-bold text-slate-800 mb-6">Gallery</h2>
                                    <GalleryView photos={gallery} addPhoto={addPhoto} deletePhoto={deletePhoto} />
                                </div>
                            )}

                            {/* SECTION: SETTINGS */}
                            {activeSection === 'SETTINGS' && (
                                <div className="animate-fade-in">
                                    <h2 className="text-2xl font-bold text-slate-800 mb-6">System Settings</h2>
                                    <SettingsView 
                                        settings={settings} setSettings={setSettings}
                                        saveData={saveData} showNotif={showNotif}
                                        doCloudSync={doCloudSync}
                                        inventory={inventory}
                                        transactions={transactions}
                                        logs={inventoryLogs}
                                        onImport={handleImport}
                                    />
                                </div>
                            )}

                        </div>
                    </main>
                    
                    {notify && <div className="fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded shadow-lg animate-bounce z-50">{notify}</div>}
                    
                    <InventoryModal 
                        key={modalOpen ? (editItem ? editItem.id : 'new') : 'closed'}
                        isOpen={modalOpen} 
                        onClose={()=>setModalOpen(false)} 
                        initialData={editItem} 
                        onSave={saveItem} 
                    />
                    
                    <TransactionModal isOpen={txModalOpen} onClose={()=>setTxModalOpen(false)} initialData={editTx} onSave={saveTx} />

                    {qrOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setQrOpen(false)}>
                            <div className="bg-white p-6 rounded-xl shadow-xl text-center" onClick={e=>e.stopPropagation()}>
                                <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.href)}`} className="mx-auto border p-2 rounded mb-4"/>
                                <p className="text-sm text-slate-500">Scan to open on phone.</p>
                                <p className="text-xs text-red-500 mt-2">Must set up Google Sheets for data sync.</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
