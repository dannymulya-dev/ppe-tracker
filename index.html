<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Coin Bekasi PPE Database</title>
    
    <!-- Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('root').innerHTML = `
                <div style="color: #b91c1c; background: #fef2f2; padding: 20px; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                    <h1 style="font-size: 24px; margin-bottom: 10px;">⚠️ App Error</h1>
                    <p><strong>${msg}</strong></p>
                    <button onclick="localStorage.clear(); window.location.reload()" style="margin-top:20px; background: #dc2626; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Reset Data</button>
                </div>
            `;
            return false;
        };
    </script>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        safety: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c', 700: '#c2410c' }
                    }
                }
            }
        }
    </script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS (Inline SVGs to prevent loading errors) ---
        const Icons = {
            Dashboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3"/><rect width="7" height="5" x="14" y="3"/><rect width="7" height="9" x="14" y="12"/><rect width="7" height="5" x="3" y="16"/></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Shield: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Qr: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M16 16l-2.74 2.74"/><path d="M21 21v-5h-5"/></svg>
        };

        // --- CONSTANTS ---
        const STORAGE_KEYS = { INVENTORY: 'ppe_inv', TRANSACTIONS: 'ppe_tx', SETTINGS: 'ppe_set' };
        
        // --- SERVICES ---
        const safeParse = (key, fallback) => { try { return JSON.parse(localStorage.getItem(key)) || fallback; } catch { return fallback; } };
        const saveData = (key, data) => localStorage.setItem(key, JSON.stringify(data));

        // Use text/plain to avoid CORS Preflight issues in simple Web Apps
        const syncSheets = async (url, inv, tx) => {
            if(!url) return;
            try { 
                await fetch(url, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'text/plain;charset=utf-8'}, 
                    body: JSON.stringify({ action: 'SYNC', inventory: inv, transactions: tx }) 
                }); 
            } catch(e) { console.log('Sync error', e); }
        };

        const fetchSheets = async (url) => {
            if(!url) return null;
            try {
                const res = await fetch(`${url}?action=GET_DATA`);
                const data = await res.json();
                return data.status === 'success' ? data : null;
            } catch(e) { return null; }
        };

        const callGemini = async (apiKey, prompt, systemInstruction) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    system_instruction: { parts: [{ text: systemInstruction }] },
                    generationConfig: { response_mime_type: "application/json" }
                })
            });
            const data = await response.json();
            if(data.error) throw new Error(data.error.message);
            return data;
        };

        // --- SUB-COMPONENTS (Defined OUTSIDE App to fix Focus Loss) ---

        const SimpleChart = ({ data }) => {
            const max = Math.max(...data.map(i=>i.quantity), 1);
            return (
                <div className="h-48 flex items-end gap-2 w-full pt-8 pb-2 overflow-x-auto">
                    {data.map(i => {
                        const h = (i.quantity / max) * 100;
                        const isLow = i.quantity <= i.threshold;
                        return (
                            <div key={i.id} className="flex-1 min-w-[40px] h-full flex flex-col justify-end group relative">
                                <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                    {i.name}: {i.quantity}
                                </div>
                                <div style={{height: `${h}%`}} className={`w-full rounded-t ${isLow ? 'bg-red-500' : 'bg-safety-500'} opacity-80 group-hover:opacity-100 transition-all`}></div>
                                <div className="text-[10px] text-slate-400 mt-1 truncate text-center">{i.name.substring(0,6)}..</div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        const InventoryModal = ({ isOpen, onClose, initialData, onSave }) => {
            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-6 animate-fade-in" onClick={e=>e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg">{initialData ? 'Edit Item' : 'Add Item'}</h3>
                            <button onClick={onClose} className="text-slate-400 font-bold text-xl">&times;</button>
                        </div>
                        <form onSubmit={(e)=>{
                            e.preventDefault();
                            const fd = new FormData(e.target);
                            onSave({
                                id: initialData ? initialData.id : Date.now().toString(),
                                name: fd.get('name'),
                                category: fd.get('category'),
                                quantity: Number(fd.get('quantity')),
                                unit: fd.get('unit'),
                                threshold: Number(fd.get('threshold')),
                                lastUpdated: new Date().toISOString()
                            });
                        }} className="space-y-4">
                            <div><label className="text-xs font-bold text-slate-500">NAME</label><input name="name" className="w-full p-2 border rounded" required defaultValue={initialData?.name}/></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-slate-500">CATEGORY</label><select name="category" className="w-full p-2 border rounded" defaultValue={initialData?.category||'General'}><option>Head</option><option>Eye</option><option>Hand</option><option>Foot</option><option>Apparel</option><option>General</option></select></div>
                                <div><label className="text-xs font-bold text-slate-500">UNIT</label><input name="unit" className="w-full p-2 border rounded" defaultValue={initialData?.unit||'pcs'}/></div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-xs font-bold text-slate-500">QTY</label><input name="quantity" type="number" className="w-full p-2 border rounded" required defaultValue={initialData?.quantity||0}/></div>
                                <div><label className="text-xs font-bold text-slate-500">LIMIT</label><input name="threshold" type="number" className="w-full p-2 border rounded" defaultValue={initialData?.threshold||5}/></div>
                            </div>
                            <button className="w-full bg-safety-600 text-white py-2 rounded font-bold hover:bg-safety-700">Save Item</button>
                        </form>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ inventory, coTab, setCoTab, coData, setCoData, aiPrompt, setAiPrompt, aiLoading, handleCheckout, handleAiCheckout }) => (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
                <div className="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border h-fit">
                    <h2 className="font-bold mb-4">Quick Checkout</h2>
                    <div className="flex border-b mb-4">
                        <button onClick={()=>setCoTab('manual')} className={`flex-1 py-2 text-sm font-bold ${coTab==='manual'?'text-safety-600 border-b-2 border-safety-600':''}`}>Manual</button>
                        <button onClick={()=>setCoTab('ai')} className={`flex-1 py-2 text-sm font-bold ${coTab==='ai'?'text-indigo-600 border-b-2 border-indigo-600':''}`}>AI Voice</button>
                    </div>
                    {coTab === 'manual' ? (
                        <form onSubmit={e=>{e.preventDefault(); handleCheckout(coData.name, coData.item, coData.qty, 'MANUAL');}} className="space-y-3">
                            <input className="w-full p-2 border rounded" placeholder="Employee Name" required value={coData.name} onChange={e=>setCoData({...coData, name: e.target.value})}/>
                            <select className="w-full p-2 border rounded" required value={coData.item} onChange={e=>setCoData({...coData, item: e.target.value})}>
                                <option value="">Select Item...</option>
                                {inventory.map(i=><option key={i.id} value={i.id} disabled={i.quantity===0}>{i.name} ({i.quantity})</option>)}
                            </select>
                            <input type="number" min="1" className="w-full p-2 border rounded" required value={coData.qty} onChange={e=>setCoData({...coData, qty: Number(e.target.value)||1})}/>
                            <button className="w-full bg-safety-600 text-white py-2 rounded font-bold hover:bg-safety-700">Submit</button>
                        </form>
                    ) : (
                        <form onSubmit={handleAiCheckout} className="space-y-3">
                            <p className="text-xs text-indigo-600 bg-indigo-50 p-2 rounded">Try: "Mike took 2 helmets"</p>
                            <textarea className="w-full p-2 border rounded h-24" placeholder="Type here..." required value={aiPrompt} onChange={e=>setAiPrompt(e.target.value)}></textarea>
                            <button disabled={aiLoading} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 disabled:opacity-50">{aiLoading?'Processing...':'Process'}</button>
                        </form>
                    )}
                </div>
                <div className="lg:col-span-2 space-y-6">
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white p-4 rounded shadow border">
                            <p className="text-xs font-bold text-slate-500 uppercase">Total Items</p>
                            <p className="text-2xl font-bold">{inventory.reduce((a,b)=>a+b.quantity,0)}</p>
                        </div>
                        <div className="bg-white p-4 rounded shadow border">
                            <p className="text-xs font-bold text-slate-500 uppercase">Low Stock</p>
                            <p className={`text-2xl font-bold ${inventory.some(i=>i.quantity<=i.threshold)?'text-red-600':'text-green-600'}`}>{inventory.filter(i=>i.quantity<=i.threshold).length}</p>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded shadow border">
                        <h3 className="font-bold mb-4">Stock Overview</h3>
                        <SimpleChart data={inventory}/>
                    </div>
                </div>
            </div>
        );

        const InventoryView = ({ inventory, setEditItem, setModalOpen, deleteItem }) => (
            <div className="space-y-4 animate-fade-in">
                <div className="flex justify-between items-center">
                    <h2 className="text-xl font-bold">Inventory List</h2>
                    <button onClick={()=>{setEditItem(null); setModalOpen(true);}} className="bg-safety-600 text-white px-4 py-2 rounded font-bold flex gap-2 items-center"><Icons.Plus/> Add Item</button>
                </div>
                <div className="bg-white rounded border overflow-x-auto">
                    <table className="w-full text-sm text-left">
                        <thead className="bg-slate-50 text-xs font-bold uppercase text-slate-500"><tr><th className="p-4">Item</th><th className="p-4">Qty</th><th className="p-4">Status</th><th className="p-4 text-right">Actions</th></tr></thead>
                        <tbody className="divide-y">
                            {inventory.map(i=>(
                                <tr key={i.id} className="hover:bg-slate-50">
                                    <td className="p-4"><div className="font-bold">{i.name}</div><div className="text-xs text-slate-400">{i.category}</div></td>
                                    <td className="p-4">{i.quantity} {i.unit}</td>
                                    <td className="p-4"><span className={`px-2 py-1 rounded-full text-xs font-bold ${i.quantity<=i.threshold?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}`}>{i.quantity<=i.threshold?'Low':'OK'}</span></td>
                                    <td className="p-4 text-right flex justify-end gap-2">
                                        <button onClick={()=>{setEditItem(i); setModalOpen(true);}} className="text-slate-400 hover:text-indigo-600"><Icons.Edit/></button>
                                        <button onClick={()=>deleteItem(i.id)} className="text-slate-400 hover:text-red-600"><Icons.Trash/></button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );

        const SettingsView = ({ settings, setSettings, saveData, showNotif, doCloudSync }) => {
            const [copied, setCopied] = useState(false);
            const [showGuide, setShowGuide] = useState(false);
            const GOOGLE_SCRIPT_CODE = `function doPost(e){var d=JSON.parse(e.postData.contents);var s=SpreadsheetApp.getActiveSpreadsheet();var i=s.getSheetByName("Inventory")||s.insertSheet("Inventory");var t=s.getSheetByName("Transactions")||s.insertSheet("Transactions");if(d.action==="SYNC"){i.clear();i.appendRow(["ID","Name","Cat","Qty","Unit","Thresh","Last"]);if(d.inventory.length)i.getRange(2,1,d.inventory.length,7).setValues(d.inventory.map(x=>[x.id,x.name,x.category,x.quantity,x.unit,x.threshold,x.lastUpdated]));t.clear();t.appendRow(["ID","Emp","Items","Time","Method"]);if(d.transactions.length)t.getRange(2,1,d.transactions.length,5).setValues(d.transactions.map(x=>[x.id,x.employeeName,x.items.map(z=>z.quantity+"x "+z.itemName).join(", "),x.timestamp,x.method]));return ContentService.createTextOutput(JSON.stringify({status:"success"})).setMimeType(ContentService.MimeType.JSON);}} function doGet(e){var s=SpreadsheetApp.getActiveSpreadsheet();var i=s.getSheetByName("Inventory");var t=s.getSheetByName("Transactions");var inv=[];var tx=[];if(i&&i.getLastRow()>1)inv=i.getRange(2,1,i.getLastRow()-1,7).getValues().map(r=>({id:String(r[0]),name:r[1],category:r[2],quantity:Number(r[3]),unit:r[4],threshold:Number(r[5]),lastUpdated:r[6]}));if(t&&t.getLastRow()>1)tx=t.getRange(2,1,t.getLastRow()-1,5).getValues().map(r=>({id:String(r[0]),employeeName:r[1],items:[{itemName:r[2],quantity:0,itemId:"0"}],timestamp:r[3],method:r[4]}));return ContentService.createTextOutput(JSON.stringify({status:"success",inventory:inv,transactions:tx})).setMimeType(ContentService.MimeType.JSON);}`;

            return (
                <div className="max-w-2xl mx-auto space-y-6 animate-fade-in pb-12">
                    <div className="bg-white p-6 rounded border">
                         <h3 className="font-bold text-lg mb-2">Google Sheets Sync (Required for Phone Access)</h3>
                         <button onClick={()=>setShowGuide(!showGuide)} className="text-indigo-600 underline text-sm font-bold mb-4">
                            {showGuide ? "Hide Guide" : "Show Setup Guide"}
                         </button>
                         {showGuide && (
                             <div className="bg-indigo-50 border border-indigo-100 p-4 rounded text-sm text-slate-700 space-y-2 mb-6">
                                <p><strong>1. Get Code:</strong> Copy the code below.</p>
                                <p><strong>2. Google Sheets:</strong> Extensions &gt; Apps Script.</p>
                                <p><strong>3. Paste & Deploy:</strong> Paste code. Click Deploy &gt; New Deployment.</p>
                                <p className="pl-4 border-l-2 border-indigo-300">
                                    Type: <strong>Web App</strong> | Access: <strong>Anyone</strong> (Critical!)
                                </p>
                                <p><strong>4. Connect:</strong> Paste the Web App URL below.</p>
                             </div>
                         )}
                         <div className="bg-slate-900 text-slate-300 p-3 rounded font-mono text-xs h-32 overflow-y-auto mb-2 relative">
                            {GOOGLE_SCRIPT_CODE}
                            <button onClick={()=>{navigator.clipboard.writeText(GOOGLE_SCRIPT_CODE); setCopied(true); setTimeout(()=>setCopied(false),2000);}} className="absolute top-2 right-2 bg-white text-slate-900 px-2 py-1 rounded font-bold text-xs hover:bg-slate-200">{copied ? "Copied!" : "Copy Code"}</button>
                         </div>
                        <label className="block text-xs font-bold text-slate-500 mb-1">Web App URL</label>
                        <input className="w-full p-2 border rounded mb-4 font-mono text-sm" placeholder="https://script.google.com/..." value={settings.sheetUrl} onChange={e=>setSettings({...settings, sheetUrl:e.target.value})}/>
                        <div className="flex gap-2">
                            <button onClick={()=>{saveData(STORAGE_KEYS.SETTINGS, settings); showNotif('Settings Saved');}} className="bg-safety-600 text-white px-4 py-2 rounded font-bold flex-1">Save</button>
                            <button onClick={doCloudSync} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold flex-1">Test Sync</button>
                        </div>
                    </div>
                    <div className="bg-white p-6 rounded border">
                        <h3 className="font-bold mb-4">Gemini AI Key</h3>
                        <input type="password" className="w-full p-2 border rounded" placeholder="Paste API Key..." value={settings.apiKey} onChange={e=>setSettings({...settings, apiKey:e.target.value})}/>
                        <button onClick={()=>{saveData(STORAGE_KEYS.SETTINGS, settings); showNotif('Key Saved');}} className="mt-2 bg-slate-200 text-slate-700 px-4 py-1 rounded text-sm font-bold">Save Key</button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('DASHBOARD');
            const [inventory, setInventory] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [settings, setSettings] = useState({ apiKey: '', sheetUrl: '' });
            const [notify, setNotify] = useState(null);
            const [modalOpen, setModalOpen] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [qrOpen, setQrOpen] = useState(false);
            const [coTab, setCoTab] = useState('manual');
            const [coData, setCoData] = useState({ name: '', item: '', qty: 1 });
            const [aiPrompt, setAiPrompt] = useState('');
            const [aiLoading, setAiLoading] = useState(false);

            const showNotif = (msg) => { setNotify(msg); setTimeout(() => setNotify(null), 3000); };

            const doCloudSync = async (silent=false) => {
                if(!settings.sheetUrl) { if(!silent) showNotif('No Sheet URL'); return; }
                if(!silent) showNotif('Syncing...');
                const cloud = await fetchSheets(settings.sheetUrl);
                if(cloud && cloud.inventory) {
                    setInventory(cloud.inventory);
                    setTransactions(cloud.transactions);
                    saveData(STORAGE_KEYS.INVENTORY, cloud.inventory);
                    saveData(STORAGE_KEYS.TRANSACTIONS, cloud.transactions);
                    if(!silent) showNotif('Sync Complete!');
                } else {
                    if(!silent) showNotif('Sync Failed');
                }
            };

            useEffect(() => {
                const s = safeParse(STORAGE_KEYS.SETTINGS, { apiKey: '', sheetUrl: '' });
                setSettings(s);
                // Load local first for speed
                setInventory(safeParse(STORAGE_KEYS.INVENTORY, [
                    { id: '1', name: 'Helmet (White)', category: 'Head', quantity: 45, unit: 'pcs', threshold: 10 },
                    { id: '5', name: 'Gloves', category: 'Hand', quantity: 120, unit: 'prs', threshold: 50 },
                ]));
                setTransactions(safeParse(STORAGE_KEYS.TRANSACTIONS, []));
                
                // Then try cloud
                if(s.sheetUrl) {
                    fetchSheets(s.sheetUrl).then(d => {
                        if(d && d.inventory) {
                            setInventory(d.inventory);
                            setTransactions(d.transactions);
                            saveData(STORAGE_KEYS.INVENTORY, d.inventory);
                            saveData(STORAGE_KEYS.TRANSACTIONS, d.transactions);
                        }
                    });
                }
            }, []);

            const updateStock = (newInv, newTx) => {
                setInventory(newInv); saveData(STORAGE_KEYS.INVENTORY, newInv);
                const txs = newTx ? [newTx, ...transactions] : transactions;
                if(newTx) { setTransactions(txs); saveData(STORAGE_KEYS.TRANSACTIONS, txs); }
                syncSheets(settings.sheetUrl, newInv, txs); // Fire and forget sync
            };

            const handleCheckout = (name, itemId, qty, method) => {
                const item = inventory.find(i => i.id === itemId);
                if (!item) return;
                const newInv = inventory.map(i => i.id === itemId ? { ...i, quantity: Math.max(0, i.quantity - qty) } : i);
                const newTx = { id: Date.now(), employeeName: name, items: [{ itemName: item.name, quantity: qty }], timestamp: new Date().toISOString(), method };
                updateStock(newInv, newTx);
                showNotif('Checkout Success');
                setCoData({ ...coData, item: '', qty: 1 });
            };

            const handleAiCheckout = async (e) => {
                e.preventDefault();
                if(!settings.apiKey) return alert("Please set API Key in Settings first.");
                setAiLoading(true);
                try {
                    const invList = inventory.map(i => `- ${i.name}`).join("\n");
                    const sys = `Extract JSON: { "employeeName": "string", "items": [{"itemNameTarget": "exact string from list", "quantity": number}] }. Inventory: \n${invList}`;
                    const res = await callGemini(settings.apiKey, aiPrompt, sys);
                    const data = JSON.parse(res.candidates[0].content.parts[0].text);
                    data.items.forEach(req => {
                        const found = inventory.find(i => i.name === req.itemNameTarget);
                        if (found) handleCheckout(data.employeeName || 'Unknown', found.id, req.quantity, 'AI');
                    });
                    setAiPrompt('');
                } catch (e) { alert("AI Error: " + e.message); }
                setAiLoading(false);
            };

            const saveItem = (item) => {
                const newInv = editItem 
                    ? inventory.map(i => i.id === item.id ? item : i)
                    : [...inventory, item];
                updateStock(newInv);
                setModalOpen(false);
                showNotif('Item Saved');
            };

            const deleteItem = (id) => {
                if(!confirm("Delete?")) return;
                updateStock(inventory.filter(i => i.id !== id));
                showNotif('Item Deleted');
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row bg-slate-50 text-slate-800">
                    <aside className="bg-slate-900 text-white w-full md:w-64 p-4 flex flex-col shrink-0">
                        <div className="mb-8 p-2">
                            <div className="flex items-center gap-2 font-bold text-lg text-safety-500"><Icons.Shield/> Gold Coin Bekasi</div>
                            <div className="text-xs text-slate-500 pl-8">PPE Database</div>
                        </div>
                        <nav className="flex-1 space-y-2">
                            {[
                                {id:'DASHBOARD', icon: Icons.Dashboard},
                                {id:'INVENTORY', icon: Icons.List},
                                {id:'HISTORY', icon: Icons.History},
                                {id:'SETTINGS', icon: Icons.Settings}
                            ].map(item => (
                                <button key={item.id} onClick={()=>setView(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded text-sm font-medium ${view===item.id?'bg-safety-600':'text-slate-400 hover:bg-slate-800'}`}>
                                    <item.icon /> {item.id.charAt(0)+item.id.slice(1).toLowerCase()}
                                </button>
                            ))}
                        </nav>
                        <div className="pt-4 border-t border-slate-800 space-y-2">
                            <button onClick={()=>setQrOpen(true)} className="flex gap-2 text-xs text-slate-400 w-full px-4 py-2 hover:bg-slate-800 rounded"><Icons.Qr/> Mobile Access</button>
                            <button onClick={()=>{doCloudSync();}} className="flex gap-2 text-xs text-green-400 w-full px-4 py-2 hover:bg-slate-800 rounded"><Icons.Refresh/> Force Sync</button>
                        </div>
                    </aside>

                    <main className="flex-1 p-4 md:p-8 overflow-y-auto">
                        <div className="max-w-6xl mx-auto">
                            {view === 'DASHBOARD' && 
                                <DashboardView 
                                    inventory={inventory} 
                                    coTab={coTab} setCoTab={setCoTab}
                                    coData={coData} setCoData={setCoData}
                                    aiPrompt={aiPrompt} setAiPrompt={setAiPrompt}
                                    aiLoading={aiLoading}
                                    handleCheckout={handleCheckout}
                                    handleAiCheckout={handleAiCheckout}
                                />
                            }
                            {view === 'INVENTORY' && 
                                <InventoryView 
                                    inventory={inventory}
                                    setEditItem={setEditItem}
                                    setModalOpen={setModalOpen}
                                    deleteItem={deleteItem}
                                />
                            }
                            {view === 'HISTORY' && (
                                <div className="space-y-4 animate-fade-in">
                                    <h2 className="text-xl font-bold">History Log</h2>
                                    {transactions.map((t,i)=>(
                                        <div key={i} className="bg-white p-4 rounded border flex justify-between">
                                            <div><div className="font-bold">{t.employeeName}</div><div className="text-xs text-slate-400">{new Date(t.timestamp).toLocaleString()}</div></div>
                                            <div className="text-right">{t.items.map((x,k)=><div key={k}>{x.itemName} <span className="font-bold text-red-600">-{x.quantity}</span></div>)}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {view === 'SETTINGS' && 
                                <SettingsView 
                                    settings={settings} setSettings={setSettings}
                                    saveData={saveData} showNotif={showNotif}
                                    doCloudSync={doCloudSync}
                                />
                            }
                        </div>
                    </main>
                    
                    {notify && <div className="fixed top-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded shadow-lg animate-bounce z-50">{notify}</div>}
                    
                    <InventoryModal isOpen={modalOpen} onClose={()=>setModalOpen(false)} initialData={editItem} onSave={saveItem} />

                    {qrOpen && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={()=>setQrOpen(false)}>
                            <div className="bg-white p-6 rounded-xl shadow-xl text-center" onClick={e=>e.stopPropagation()}>
                                <img src={`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(window.location.href)}`} className="mx-auto border p-2 rounded mb-4"/>
                                <p className="text-sm text-slate-500">Scan to open on phone.</p>
                                <p className="text-xs text-red-500 mt-2">Must set up Google Sheets for data sync.</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
